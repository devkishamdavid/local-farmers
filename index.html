<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmers Market | Complete Local Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2E7D32;
            --primary-light: #4CAF50;
            --secondary-color: #FF9800;
            --dark-color: #1B5E20;
            --light-color: #F1F8E9;
            --text-color: #333;
            --text-light: #666;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header & Navigation */
        header {
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--dark-color);
            font-size: 1.9rem;
            font-weight: 800;
            text-decoration: none;
        }

        .logo i {
            color: var(--primary-light);
            font-size: 2.2rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        nav a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.05rem;
            padding: 8px 4px;
            position: relative;
            transition: var(--transition);
        }

        nav a:hover, nav a.active {
            color: var(--primary-light);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-light);
            border-radius: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cart-icon {
            position: relative;
            font-size: 1.4rem;
            color: var(--text-color);
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--secondary-color);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-light);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--dark-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #e68900;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-light);
            color: var(--primary-light);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                        url('https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
            margin-bottom: 60px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            font-weight: 800;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto 40px;
            opacity: 0.9;
        }

        /* Main Content */
        .content-wrapper {
            display: flex;
            gap: 40px;
            margin-bottom: 80px;
            min-height: 600px;
        }

        .sidebar {
            flex: 0 0 280px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            height: fit-content;
        }

        .sidebar-title {
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            font-size: 1.4rem;
        }

        .sidebar-menu {
            list-style: none;
            margin-bottom: 30px;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: block;
            padding: 14px 18px;
            text-decoration: none;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--light-color);
            color: var(--primary-light);
        }

        .sidebar-menu i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }

        .main-content {
            flex: 1;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px;
            min-height: 600px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }

        .page-title {
            color: var(--dark-color);
            font-size: 2rem;
            font-weight: 700;
        }

        /* Forms */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-container h2 {
            color: var(--primary-light);
            margin-bottom: 30px;
            text-align: center;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 15px 18px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #fdfdfd;
        }

        .form-control:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: white;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Products */
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-box input {
            padding-left: 50px;
            width: 100%;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            font-weight: 500;
            color: var(--text-color);
            cursor: pointer;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .product-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid #eee;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .product-img-container {
            height: 220px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .product-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .product-info {
            padding: 25px;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .product-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-right: 10px;
        }

        .product-price {
            font-size: 1.6rem;
            color: var(--primary-light);
            font-weight: 800;
            white-space: nowrap;
        }

        .product-farmer {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .product-farmer i {
            color: var(--primary-light);
        }

        .product-description {
            color: var(--text-light);
            margin-bottom: 20px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .product-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .product-meta i {
            color: var(--primary-light);
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--dark-color);
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background-color: #f5f5f5;
            color: var(--text-color);
        }

        .modal-body {
            padding: 30px;
        }

        /* Cart */
        .cart-item {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .cart-item-farmer {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .cart-item-price {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.2rem;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 5px 10px;
        }

        .quantity-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .quantity-btn:hover {
            background-color: #f5f5f5;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 0;
            font-size: 1.5rem;
            font-weight: 700;
            border-top: 2px solid #eee;
            margin-top: 20px;
        }

        /* Checkout Steps */
        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .checkout-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background-color: #eee;
            z-index: 1;
        }

        .checkout-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-light);
            transition: var(--transition);
        }

        .checkout-step.active .step-number {
            background-color: var(--primary-light);
            color: white;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95rem;
            text-align: center;
        }

        .checkout-step.active .step-title {
            color: var(--primary-light);
        }

        /* Payment */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .payment-method {
            border: 2px solid #eee;
            border-radius: var(--border-radius);
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-method:hover {
            border-color: var(--primary-light);
        }

        .payment-method.selected {
            border-color: var(--primary-light);
            background-color: rgba(76, 175, 80, 0.05);
        }

        .payment-method i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-light);
        }

        .payment-method-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Reviews */
        .review-card {
            background-color: #fdfdfd;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #eee;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reviewer {
            font-weight: 600;
            color: var(--dark-color);
        }

        .review-rating {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .review-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .review-text {
            line-height: 1.6;
            color: var(--text-color);
        }

        .rating-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .rating-input input {
            display: none;
        }

        .rating-input label {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: var(--transition);
        }

        .rating-input input:checked ~ label,
        .rating-input label:hover,
        .rating-input label:hover ~ label {
            color: var(--secondary-color);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            z-index: 3000;
            max-width: 350px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            transform: translateX(400px);
            transition: transform 0.3s;
            border-left: 5px solid var(--primary-light);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 1.5rem;
            color: var(--primary-light);
            margin-top: 3px;
        }

        .notification-content h4 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .notification-content p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 70px 0 30px;
            margin-top: 80px;
        }

        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 50px;
        }

        .footer-column h3 {
            font-size: 1.4rem;
            margin-bottom: 25px;
            color: white;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-links a:hover {
            color: white;
            transform: translateX(5px);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                flex: 0 0 auto;
            }
        }

        @media (max-width: 992px) {
            .hero h1 {
                font-size: 2.8rem;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 20px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 20px;
            }
            
            .hero {
                padding: 70px 0;
            }
            
            .hero h1 {
                font-size: 2.2rem;
            }
            
            .hero p {
                font-size: 1.1rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .products-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .modal-content {
                padding: 15px;
            }
        }

        @media (max-width: 576px) {
            .container {
                width: 95%;
                padding: 0 15px;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                padding: 25px 20px;
            }
            
            .cart-item {
                flex-direction: column;
            }
            
            .cart-item-img {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <a href="#" class="logo" id="home-link">
                <i class="fas fa-seedling"></i>
                <span>FarmersMarket</span>
            </a>
            
            <nav>
                <ul>
                    <li><a href="#" id="nav-home" class="active">Home</a></li>
                    <li><a href="#" id="nav-market">Marketplace</a></li>
                    <li><a href="#" id="nav-farmers">Farmers</a></li>
                    <li><a href="#" id="nav-how">How It Works</a></li>
                    <li><a href="#" id="nav-about">About</a></li>
                </ul>
            </nav>
            
            <div class="header-actions">
                <div class="cart-icon" id="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cart-count">0</span>
                </div>
                
                <div id="auth-buttons">
                    <button class="btn btn-outline btn-sm" id="login-btn">Log In</button>
                    <button class="btn btn-primary btn-sm" id="signup-btn">Sign Up</button>
                </div>
                
                <div id="user-menu" style="display: none;">
                    <button class="btn btn-outline btn-sm" id="dashboard-btn">
                        <i class="fas fa-user-circle"></i> Dashboard
                    </button>
                    <button class="btn btn-outline btn-sm" id="logout-btn">Log Out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Fresh From Local Farms To Your Table</h1>
            <p>Connect directly with local farmers. Buy fresh, organic produce straight from the source. Support your community while enjoying the highest quality food.</p>
            <button class="btn btn-secondary btn-lg" id="hero-market-btn">
                <i class="fas fa-store"></i> Browse Marketplace
            </button>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <div id="content-area">
            <!-- Home content will be loaded here -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-container">
                <div class="footer-column">
                    <h3>FarmersMarket</h3>
                    <p>Connecting local farmers directly with consumers. Our mission is to support sustainable agriculture and provide fresh, local produce to our community.</p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-chevron-right"></i> How It Works</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> For Farmers</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> For Buyers</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Us</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-envelope"></i> support@farmersmarket.com</a></li>
                        <li><a href="#"><i class="fas fa-phone"></i> (123) 456-7890</a></li>
                        <li><a href="#"><i class="fas fa-map-marker-alt"></i> 123 Farm Street, AgCity</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Connect</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fab fa-facebook"></i> Facebook</a></li>
                        <li><a href="#"><i class="fab fa-twitter"></i> Twitter</a></li>
                        <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                        <li><a href="#"><i class="fab fa-youtube"></i> YouTube</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 FarmersMarket. All rights reserved. | <a href="#" style="color: rgba(255, 255, 255, 0.8);">Privacy Policy</a> | <a href="#" style="color: rgba(255, 255, 255, 0.8);">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-content">
            <h4 id="notification-title">Success!</h4>
            <p id="notification-message">Operation completed successfully.</p>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Your Cart</h3>
                <button class="close-modal" id="close-cart-modal">&times;</button>
            </div>
            <div class="modal-body" id="cart-modal-body">
                <!-- Cart items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Checkout</h3>
                <button class="close-modal" id="close-checkout-modal">&times;</button>
            </div>
            <div class="modal-body" id="checkout-modal-body">
                <!-- Checkout steps will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="product-modal-title">Product Details</h3>
                <button class="close-modal" id="close-product-modal">&times;</button>
            </div>
            <div class="modal-body" id="product-modal-body">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // =============== FARMERS MARKET SYSTEM - COMPLETE IMPLEMENTATION ===============
        // This is a production-ready prototype with simulated backend, database, 
        // payment processing, and email notifications

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            });
        }

        // =============== DATABASE SIMULATION ===============
        class Database {
            constructor() {
                this.init();
            }
            
            init() {
                // Initialize local storage with sample data if empty
                if (!localStorage.getItem('farmersMarketDB')) {
                    const initialData = {
                        users: this.getSampleUsers(),
                        products: this.getSampleProducts(),
                        orders: [],
                        reviews: this.getSampleReviews(),
                        cart: {},
                        notifications: []
                    };
                    localStorage.setItem('farmersMarketDB', JSON.stringify(initialData));
                }
            }
            
            getSampleUsers() {
                return [
                    {
                        id: 1,
                        email: "farmer@example.com",
                        password: "password123",
                        type: "farmer",
                        name: "Green Valley Farm",
                        location: "Springfield, CA",
                        phone: "(555) 123-4567",
                        bio: "Family-owned farm since 1950. We grow organic vegetables and fruits using sustainable practices.",
                        joined: "2022-03-15",
                        rating: 4.8,
                        products: [1, 2]
                    },
                    {
                        id: 2,
                        email: "buyer@example.com",
                        password: "password123",
                        type: "buyer",
                        name: "Jane Smith",
                        location: "Springfield, CA",
                        phone: "(555) 987-6543",
                        bio: "Local food enthusiast and home cook.",
                        joined: "2023-01-20",
                        orders: [1]
                    },
                    {
                        id: 3,
                        email: "happyhen@example.com",
                        password: "password123",
                        type: "farmer",
                        name: "Happy Hen Farm",
                        location: "Riverside, CA",
                        phone: "(555) 456-7890",
                        bio: "Free-range eggs and poultry from humanely raised chickens.",
                        joined: "2021-11-10",
                        rating: 4.9,
                        products: [3]
                    }
                ];
            }
            
            getSampleProducts() {
                return [
                    {
                        id: 1,
                        farmerId: 1,
                        name: "Organic Tomatoes",
                        category: "vegetables",
                        price: 3.99,
                        unit: "per lb",
                        farmer: "Green Valley Farm",
                        location: "Springfield, CA",
                        description: "Fresh, vine-ripened organic tomatoes grown without pesticides. Perfect for salads, sauces, and sandwiches. Harvested daily for maximum freshness.",
                        image: "https://images.unsplash.com/photo-1592924357228-91a4daadcfea?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80",
                        delivery: true,
                        deliveryFee: 2.99,
                        paymentMethods: ["credit_card", "paypal", "cash"],
                        stock: 50,
                        rating: 4.7,
                        reviews: [1, 2],
                        createdAt: "2023-08-15",
                        featured: true
                    },
                    {
                        id: 2,
                        farmerId: 1,
                        name: "Fresh Kale",
                        category: "vegetables",
                        price: 2.99,
                        unit: "per bunch",
                        farmer: "Green Valley Farm",
                        location: "Springfield, CA",
                        description: "Nutrient-rich organic kale, perfect for smoothies, salads, and cooking. Packed with vitamins and minerals.",
                        image: "https://images.unsplash.com/photo-1540420828642-fca2c5c18abb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80",
                        delivery: true,
                        deliveryFee: 2.99,
                        paymentMethods: ["credit_card", "cash"],
                        stock: 30,
                        rating: 4.5,
                        reviews: [],
                        createdAt: "2023-08-20",
                        featured: true
                    },
                    {
                        id: 3,
                        farmerId: 3,
                        name: "Free-Range Eggs",
                        category: "dairy-eggs",
                        price: 5.50,
                        unit: "per dozen",
                        farmer: "Happy Hen Farm",
                        location: "Riverside, CA",
                        description: "Free-range brown eggs from happy, healthy chickens raised on pasture. Rich in flavor and nutrients.",
                        image: "https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80",
                        delivery: false,
                        deliveryFee: 0,
                        paymentMethods: ["credit_card", "venmo", "cash"],
                        stock: 25,
                        rating: 4.9,
                        reviews: [3],
                        createdAt: "2023-08-10",
                        featured: true
                    },
                    {
                        id: 4,
                        farmerId: 1,
                        name: "Organic Apples",
                        category: "fruits",
                        price: 2.99,
                        unit: "per lb",
                        farmer: "Green Valley Farm",
                        location: "Springfield, CA",
                        description: "Crisp, sweet organic apples in several varieties including Fuji, Gala, and Honeycrisp. Perfect for eating fresh or baking.",
                        image: "https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80",
                        delivery: true,
                        deliveryFee: 2.99,
                        paymentMethods: ["credit_card", "paypal"],
                        stock: 100,
                        rating: 4.6,
                        reviews: [],
                        createdAt: "2023-09-01",
                        featured: false
                    }
                ];
            }
            
            getSampleReviews() {
                return [
                    {
                        id: 1,
                        productId: 1,
                        userId: 2,
                        userName: "Jane Smith",
                        rating: 5,
                        comment: "Best tomatoes I've ever had! So flavorful and fresh.",
                        date: "2023-08-20"
                    },
                    {
                        id: 2,
                        productId: 1,
                        userId: 3,
                        userName: "Mike Johnson",
                        rating: 4,
                        comment: "Great quality, arrived fresh. Will order again!",
                        date: "2023-08-25"
                    },
                    {
                        id: 3,
                        productId: 3,
                        userId: 2,
                        userName: "Jane Smith",
                        rating: 5,
                        comment: "The eggs are amazing! Bright orange yolks and fantastic flavor.",
                        date: "2023-08-18"
                    }
                ];
            }
            
            getDB() {
                return JSON.parse(localStorage.getItem('farmersMarketDB'));
            }
            
            updateDB(data) {
                localStorage.setItem('farmersMarketDB', JSON.stringify(data));
            }
            
            // User operations
            getUserById(id) {
                const db = this.getDB();
                return db.users.find(user => user.id === id);
            }
            
            getUserByEmail(email) {
                const db = this.getDB();
                return db.users.find(user => user.email === email);
            }
            
            createUser(userData) {
                const db = this.getDB();
                const newId = Math.max(...db.users.map(u => u.id)) + 1;
                const newUser = {
                    id: newId,
                    ...userData,
                    joined: new Date().toISOString().split('T')[0],
                    orders: [],
                    products: [],
                    rating: userData.type === 'farmer' ? 0 : null
                };
                db.users.push(newUser);
                this.updateDB(db);
                return newUser;
            }
            
            updateUser(userId, updates) {
                const db = this.getDB();
                const userIndex = db.users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    db.users[userIndex] = { ...db.users[userIndex], ...updates };
                    this.updateDB(db);
                    return db.users[userIndex];
                }
                return null;
            }
            
            // Product operations
            getAllProducts() {
                const db = this.getDB();
                return db.products;
            }
            
            getProductById(id) {
                const db = this.getDB();
                return db.products.find(product => product.id === id);
            }
            
            getProductsByFarmer(farmerId) {
                const db = this.getDB();
                return db.products.filter(product => product.farmerId === farmerId);
            }
            
            createProduct(productData) {
                const db = this.getDB();
                const newId = Math.max(...db.products.map(p => p.id)) + 1;
                const newProduct = {
                    id: newId,
                    ...productData,
                    createdAt: new Date().toISOString().split('T')[0],
                    rating: 0,
                    reviews: [],
                    stock: productData.stock || 10
                };
                db.products.push(newProduct);
                
                // Add product to farmer's products list
                const farmer = db.users.find(u => u.id === productData.farmerId);
                if (farmer) {
                    farmer.products.push(newId);
                }
                
                this.updateDB(db);
                return newProduct;
            }
            
            updateProduct(productId, updates) {
                const db = this.getDB();
                const productIndex = db.products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    db.products[productIndex] = { ...db.products[productIndex], ...updates };
                    this.updateDB(db);
                    return db.products[productIndex];
                }
                return null;
            }
            
            deleteProduct(productId) {
                const db = this.getDB();
                const productIndex = db.products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    // Remove from farmer's products list
                    const product = db.products[productIndex];
                    const farmer = db.users.find(u => u.id === product.farmerId);
                    if (farmer) {
                        farmer.products = farmer.products.filter(id => id !== productId);
                    }
                    
                    db.products.splice(productIndex, 1);
                    this.updateDB(db);
                    return true;
                }
                return false;
            }
            
            // Cart operations
            getCart(userId) {
                const db = this.getDB();
                return db.cart[userId] || {};
            }
            
            updateCart(userId, cartData) {
                const db = this.getDB();
                db.cart[userId] = cartData;
                this.updateDB(db);
            }
            
            clearCart(userId) {
                const db = this.getDB();
                db.cart[userId] = {};
                this.updateDB(db);
            }
            
            // Order operations
            createOrder(orderData) {
                const db = this.getDB();
                const newId = db.orders.length > 0 ? Math.max(...db.orders.map(o => o.id)) + 1 : 1;
                const order = {
                    id: newId,
                    ...orderData,
                    orderDate: new Date().toISOString().split('T')[0],
                    status: 'pending',
                    trackingNumber: `FM${Date.now().toString().slice(-8)}`
                };
                db.orders.push(order);
                
                // Add order to buyer's orders
                const buyer = db.users.find(u => u.id === orderData.buyerId);
                if (buyer) {
                    buyer.orders.push(newId);
                }
                
                this.updateDB(db);
                return order;
            }
            
            getOrdersByUser(userId, userType) {
                const db = this.getDB();
                if (userType === 'buyer') {
                    return db.orders.filter(order => order.buyerId === userId);
                } else {
                    // For farmers, get orders for their products
                    const farmerProducts = db.products.filter(p => p.farmerId === userId);
                    const productIds = farmerProducts.map(p => p.id);
                    return db.orders.filter(order => 
                        order.items.some(item => productIds.includes(item.productId))
                    );
                }
            }
            
            updateOrderStatus(orderId, status) {
                const db = this.getDB();
                const orderIndex = db.orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    db.orders[orderIndex].status = status;
                    db.orders[orderIndex].updatedAt = new Date().toISOString();
                    this.updateDB(db);
                    return db.orders[orderIndex];
                }
                return null;
            }
            
            // Review operations
            createReview(reviewData) {
                const db = this.getDB();
                const newId = db.reviews.length > 0 ? Math.max(...db.reviews.map(r => r.id)) + 1 : 1;
                const review = {
                    id: newId,
                    ...reviewData,
                    date: new Date().toISOString().split('T')[0]
                };
                db.reviews.push(review);
                
                // Add review to product
                const product = db.products.find(p => p.id === reviewData.productId);
                if (product) {
                    product.reviews.push(newId);
                    
                    // Update product rating
                    const productReviews = db.reviews.filter(r => r.productId === product.id);
                    if (productReviews.length > 0) {
                        const avgRating = productReviews.reduce((sum, r) => sum + r.rating, 0) / productReviews.length;
                        product.rating = Math.round(avgRating * 10) / 10;
                    }
                }
                
                this.updateDB(db);
                return review;
            }
            
            getReviewsByProduct(productId) {
                const db = this.getDB();
                return db.reviews.filter(review => review.productId === productId);
            }
            
            // Notification operations
            addNotification(notification) {
                const db = this.getDB();
                if (!db.notifications) db.notifications = [];
                db.notifications.push({
                    id: Date.now(),
                    ...notification,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                this.updateDB(db);
            }
            
            getUserNotifications(userId) {
                const db = this.getDB();
                return (db.notifications || []).filter(n => n.userId === userId && !n.read);
            }
            
            markNotificationAsRead(notificationId) {
                const db = this.getDB();
                const notification = db.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.updateDB(db);
                }
            }
        }

        // =============== PAYMENT SERVICE SIMULATION ===============
        class PaymentService {
            constructor() {
                this.stripePublicKey = 'pk_test_simulated_key_123456789';
            }
            
            async processPayment(paymentData) {
                // Simulate API call to payment processor
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Simulate payment processing
                        const success = Math.random() > 0.1; // 90% success rate
                        
                        if (success) {
                            resolve({
                                success: true,
                                transactionId: `txn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                amount: paymentData.amount,
                                currency: 'USD',
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            reject({
                                success: false,
                                error: 'Payment failed. Please check your payment details and try again.'
                            });
                        }
                    }, 1500);
                });
            }
            
            getPaymentMethods() {
                return [
                    {
                        id: 'credit_card',
                        name: 'Credit Card',
                        icon: 'fa-credit-card',
                        description: 'Pay with Visa, Mastercard, or American Express'
                    },
                    {
                        id: 'paypal',
                        name: 'PayPal',
                        icon: 'fa-paypal',
                        description: 'Pay with your PayPal account'
                    },
                    {
                        id: 'apple_pay',
                        name: 'Apple Pay',
                        icon: 'fa-apple',
                        description: 'Pay with Apple Pay'
                    },
                    {
                        id: 'google_pay',
                        name: 'Google Pay',
                        icon: 'fa-google',
                        description: 'Pay with Google Pay'
                    },
                    {
                        id: 'venmo',
                        name: 'Venmo',
                        icon: 'fa-university',
                        description: 'Pay with Venmo'
                    },
                    {
                        id: 'cash',
                        name: 'Cash on Delivery',
                        icon: 'fa-money-bill-wave',
                        description: 'Pay with cash when you receive your order'
                    }
                ];
            }
        }

        // =============== EMAIL SERVICE SIMULATION ===============
        class EmailService {
            constructor() {
                this.templates = {
                    orderConfirmation: this.orderConfirmationTemplate,
                    farmerNotification: this.farmerNotificationTemplate,
                    welcome: this.welcomeTemplate,
                    passwordReset: this.passwordResetTemplate
                };
            }
            
            orderConfirmationTemplate(order, buyer) {
                return {
                    subject: `Order Confirmation #${order.id}`,
                    body: `
                        <h2>Thank you for your order!</h2>
                        <p>Dear ${buyer.name},</p>
                        <p>Your order #${order.id} has been received and is being processed.</p>
                        <h3>Order Summary:</h3>
                        <ul>
                            ${order.items.map(item => `<li>${item.name} - ${item.quantity} x $${item.price} = $${item.total}</li>`).join('')}
                        </ul>
                        <p><strong>Total: $${order.total}</strong></p>
                        <p>You will receive another email when your order ships.</p>
                        <p>Thank you for supporting local farmers!</p>
                    `
                };
            }
            
            farmerNotificationTemplate(order, farmer, products) {
                const orderItems = order.items.filter(item => 
                    products.some(p => p.id === item.productId && p.farmerId === farmer.id)
                );
                
                return {
                    subject: `New Order Received #${order.id}`,
                    body: `
                        <h2>New Order Alert!</h2>
                        <p>Dear ${farmer.name},</p>
                        <p>You have received a new order from ${order.buyerName}.</p>
                        <h3>Order Details:</h3>
                        <ul>
                            ${orderItems.map(item => `<li>${item.name} - ${item.quantity} x $${item.price} = $${item.total}</li>`).join('')}
                        </ul>
                        <p><strong>Total for your products: $${orderItems.reduce((sum, item) => sum + item.total, 0).toFixed(2)}</strong></p>
                        <p>Please prepare the items for ${order.deliveryMethod === 'delivery' ? 'delivery' : 'pickup'}.</p>
                        <p>Buyer contact: ${order.buyerEmail} | ${order.buyerPhone}</p>
                    `
                };
            }
            
            welcomeTemplate(user) {
                return {
                    subject: `Welcome to FarmersMarket, ${user.name}!`,
                    body: `
                        <h2>Welcome to FarmersMarket!</h2>
                        <p>Dear ${user.name},</p>
                        <p>Thank you for joining FarmersMarket, your local farmers marketplace.</p>
                        ${user.type === 'farmer' 
                            ? `<p>As a farmer, you can now list your products and start selling directly to customers in your area.</p>`
                            : `<p>As a buyer, you can now browse fresh local products and support your community farmers.</p>`
                        }
                        <p>We're excited to have you as part of our community!</p>
                    `
                };
            }
            
            async sendEmail(to, template, data) {
                // In a real app, this would make an API call to an email service
                // For this demo, we'll simulate sending and log to console
                console.log(`[EMAIL SENT] To: ${to}`);
                console.log(`Subject: ${template.subject}`);
                console.log(`Body: ${template.body}`);
                
                // Simulate email sending delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return {
                    success: true,
                    messageId: `email_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
            }
        }

        // =============== APPLICATION STATE ===============
        class AppState {
            constructor() {
                this.currentUser = null;
                this.currentView = 'home';
                this.currentProduct = null;
                this.cart = {};
                this.db = new Database();
                this.paymentService = new PaymentService();
                this.emailService = new EmailService();
                this.notifications = [];
                this.init();
            }
            
            init() {
                // Load user from localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.loadUserCart();
                }
                
                // Load notifications
                this.loadNotifications();
            }
            
            loadUserCart() {
                if (this.currentUser) {
                    this.cart = this.db.getCart(this.currentUser.id);
                }
            }
            
            loadNotifications() {
                if (this.currentUser) {
                    this.notifications = this.db.getUserNotifications(this.currentUser.id);
                }
            }
            
            updateCartCount() {
                const totalItems = Object.values(this.cart).reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('cart-count').textContent = totalItems;
            }
            
            async login(email, password) {
                const user = this.db.getUserByEmail(email);
                
                if (user && user.password === password) {
                    this.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    this.loadUserCart();
                    this.loadNotifications();
                    
                    // Send welcome email if first login
                    if (!user.lastLogin) {
                        const template = this.emailService.templates.welcome(user);
                        await this.emailService.sendEmail(user.email, template, { user });
                        this.db.updateUser(user.id, { lastLogin: new Date().toISOString() });
                    }
                    
                    return { success: true, user };
                }
                
                return { success: false, error: 'Invalid email or password' };
            }
            
            logout() {
                this.currentUser = null;
                this.cart = {};
                localStorage.removeItem('currentUser');
                this.notifications = [];
            }
            
            async register(userData) {
                // Check if user already exists
                if (this.db.getUserByEmail(userData.email)) {
                    return { success: false, error: 'Email already registered' };
                }
                
                // Create new user
                const newUser = this.db.createUser(userData);
                this.currentUser = newUser;
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                
                // Send welcome email
                const template = this.emailService.templates.welcome(newUser);
                await this.emailService.sendEmail(newUser.email, template, { user: newUser });
                
                return { success: true, user: newUser };
            }
            
            addToCart(productId, quantity = 1) {
                if (!this.currentUser || this.currentUser.type !== 'buyer') {
                    return { success: false, error: 'You must be logged in as a buyer to add to cart' };
                }
                
                const product = this.db.getProductById(productId);
                if (!product) {
                    return { success: false, error: 'Product not found' };
                }
                
                if (product.stock < quantity) {
                    return { success: false, error: `Only ${product.stock} items available in stock` };
                }
                
                const cartKey = `${productId}`;
                if (this.cart[cartKey]) {
                    this.cart[cartKey].quantity += quantity;
                } else {
                    this.cart[cartKey] = {
                        productId,
                        name: product.name,
                        price: product.price,
                        farmer: product.farmer,
                        image: product.image,
                        quantity,
                        total: product.price * quantity
                    };
                }
                
                // Update database
                this.db.updateCart(this.currentUser.id, this.cart);
                this.updateCartCount();
                
                return { success: true, cart: this.cart };
            }
            
            removeFromCart(productId) {
                const cartKey = `${productId}`;
                if (this.cart[cartKey]) {
                    delete this.cart[cartKey];
                    this.db.updateCart(this.currentUser.id, this.cart);
                    this.updateCartCount();
                    return { success: true };
                }
                return { success: false, error: 'Item not in cart' };
            }
            
            updateCartItem(productId, quantity) {
                const cartKey = `${productId}`;
                if (this.cart[cartKey]) {
                    if (quantity <= 0) {
                        return this.removeFromCart(productId);
                    }
                    
                    const product = this.db.getProductById(productId);
                    if (product.stock < quantity) {
                        return { success: false, error: `Only ${product.stock} items available in stock` };
                    }
                    
                    this.cart[cartKey].quantity = quantity;
                    this.cart[cartKey].total = product.price * quantity;
                    this.db.updateCart(this.currentUser.id, this.cart);
                    this.updateCartCount();
                    return { success: true };
                }
                return { success: false, error: 'Item not in cart' };
            }
            
            getCartTotal() {
                return Object.values(this.cart).reduce((sum, item) => sum + item.total, 0);
            }
            
            async checkout(orderData) {
                if (!this.currentUser || this.currentUser.type !== 'buyer') {
                    return { success: false, error: 'You must be logged in as a buyer to checkout' };
                }
                
                if (Object.keys(this.cart).length === 0) {
                    return { success: false, error: 'Your cart is empty' };
                }
                
                // Process payment
                try {
                    const paymentResult = await this.paymentService.processPayment({
                        amount: this.getCartTotal(),
                        method: orderData.paymentMethod,
                        currency: 'USD'
                    });
                    
                    // Create order
                    const items = Object.values(this.cart).map(item => ({
                        productId: item.productId,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        total: item.total
                    }));
                    
                    const order = this.db.createOrder({
                        buyerId: this.currentUser.id,
                        buyerName: this.currentUser.name,
                        buyerEmail: this.currentUser.email,
                        buyerPhone: this.currentUser.phone,
                        items,
                        total: this.getCartTotal(),
                        shippingAddress: orderData.shippingAddress,
                        deliveryMethod: orderData.deliveryMethod,
                        paymentMethod: orderData.paymentMethod,
                        paymentStatus: 'paid',
                        paymentTransactionId: paymentResult.transactionId
                    });
                    
                    // Update product stock
                    items.forEach(item => {
                        const product = this.db.getProductById(item.productId);
                        if (product) {
                            this.db.updateProduct(item.productId, {
                                stock: product.stock - item.quantity
                            });
                        }
                    });
                    
                    // Send confirmation email to buyer
                    const buyerTemplate = this.emailService.templates.orderConfirmation(order, this.currentUser);
                    await this.emailService.sendEmail(this.currentUser.email, buyerTemplate, { order, buyer: this.currentUser });
                    
                    // Send notifications to farmers
                    const farmers = {};
                    items.forEach(item => {
                        const product = this.db.getProductById(item.productId);
                        if (product && !farmers[product.farmerId]) {
                            farmers[product.farmerId] = {
                                farmer: this.db.getUserById(product.farmerId),
                                products: items.filter(i => {
                                    const p = this.db.getProductById(i.productId);
                                    return p && p.farmerId === product.farmerId;
                                })
                            };
                        }
                    });
                    
                    for (const farmerId in farmers) {
                        const { farmer, products } = farmers[farmerId];
                        const farmerTemplate = this.emailService.templates.farmerNotification(
                            { ...order, items: products },
                            farmer,
                            products.map(p => this.db.getProductById(p.productId))
                        );
                        await this.emailService.sendEmail(farmer.email, farmerTemplate, { order, farmer, products });
                        
                        // Add notification to database
                        this.db.addNotification({
                            userId: farmer.id,
                            type: 'new_order',
                            title: 'New Order Received',
                            message: `You have a new order #${order.id} from ${this.currentUser.name}`,
                            link: `/dashboard/orders/${order.id}`
                        });
                    }
                    
                    // Clear cart
                    this.cart = {};
                    this.db.clearCart(this.currentUser.id);
                    this.updateCartCount();
                    
                    return { success: true, order, paymentResult };
                    
                } catch (error) {
                    return { success: false, error: error.error || 'Payment processing failed' };
                }
            }
            
            async addProduct(productData) {
                if (!this.currentUser || this.currentUser.type !== 'farmer') {
                    return { success: false, error: 'Only farmers can add products' };
                }
                
                const product = this.db.createProduct({
                    ...productData,
                    farmerId: this.currentUser.id,
                    farmer: this.currentUser.name
                });
                
                // Add notification to database
                this.db.addNotification({
                    userId: this.currentUser.id,
                    type: 'product_added',
                    title: 'Product Added',
                    message: `Your product "${product.name}" has been listed successfully`,
                    link: `/dashboard/products/${product.id}`
                });
                
                return { success: true, product };
            }
            
            showNotification(title, message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notification-title');
                const notificationMessage = document.getElementById('notification-message');
                
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                // Set color based on type
                if (type === 'error') {
                    notification.style.borderLeftColor = '#f44336';
                    notification.querySelector('.notification-icon i').className = 'fas fa-exclamation-circle';
                } else if (type === 'warning') {
                    notification.style.borderLeftColor = '#ff9800';
                    notification.querySelector('.notification-icon i').className = 'fas fa-exclamation-triangle';
                } else {
                    notification.style.borderLeftColor = '#4CAF50';
                    notification.querySelector('.notification-icon i').className = 'fas fa-check-circle';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
        }

        // =============== UI MANAGER ===============
        class UIManager {
            constructor(appState) {
                this.app = appState;
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.renderHome();
                this.updateUI();
            }
            
            bindEvents() {
                // Navigation
                document.getElementById('home-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.renderHome();
                });
                
                document.getElementById('nav-home').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.renderHome();
                });
                
                document.getElementById('nav-market').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.renderMarketplace();
                });
                
                document.getElementById('hero-market-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.renderMarketplace();
                });
                
                document.getElementById('cart-icon').addEventListener('click', () => {
                    this.renderCart();
                });
                
                // Auth buttons
                document.getElementById('login-btn').addEventListener('click', () => {
                    this.renderLoginForm();
                });
                
                document.getElementById('signup-btn').addEventListener('click', () => {
                    this.renderSignupForm();
                });
                
                document.getElementById('dashboard-btn').addEventListener('click', () => {
                    this.renderDashboard();
                });
                
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.app.logout();
                    this.updateUI();
                    this.renderHome();
                    this.app.showNotification('Logged Out', 'You have been successfully logged out.');
                });
                
                // Modal close buttons
                document.getElementById('close-cart-modal').addEventListener('click', () => {
                    document.getElementById('cart-modal').style.display = 'none';
                });
                
                document.getElementById('close-checkout-modal').addEventListener('click', () => {
                    document.getElementById('checkout-modal').style.display = 'none';
                });
                
                document.getElementById('close-product-modal').addEventListener('click', () => {
                    document.getElementById('product-modal').style.display = 'none';
                });
                
                // Close modals when clicking outside
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }
            
            updateUI() {
                const authButtons = document.getElementById('auth-buttons');
                const userMenu = document.getElementById('user-menu');
                
                if (this.app.currentUser) {
                    authButtons.style.display = 'none';
                    userMenu.style.display = 'flex';
                    document.getElementById('cart-icon').style.display = 'flex';
                    document.getElementById('cart-count').textContent = Object.values(this.app.cart).reduce((sum, item) => sum + item.quantity, 0);
                } else {
                    authButtons.style.display = 'flex';
                    userMenu.style.display = 'none';
                    document.getElementById('cart-icon').style.display = 'none';
                }
                
                // Update active nav
                document.querySelectorAll('nav a').forEach(link => {
                    link.classList.remove('active');
                });
                
                if (this.app.currentView === 'home') {
                    document.getElementById('nav-home').classList.add('active');
                } else if (this.app.currentView === 'market') {
                    document.getElementById('nav-market').classList.add('active');
                }
            }
            
            renderHome() {
                this.app.currentView = 'home';
                const products = this.app.db.getAllProducts().filter(p => p.featured);
                
                document.getElementById('content-area').innerHTML = `
                    <div class="content-wrapper">
                        <div class="main-content">
                            <div class="page-header">
                                <h1 class="page-title">Featured Products</h1>
                                <p>Fresh from local farms</p>
                            </div>
                            
                            <div class="products-grid" id="featured-products">
                                ${products.map(product => this.renderProductCard(product)).join('')}
                            </div>
                            
                            ${!this.app.currentUser ? `
                                <div class="form-container" style="max-width: 800px; margin: 40px auto 0;">
                                    <div style="text-align: center; padding: 30px;">
                                        <h2 style="margin-bottom: 20px;">Join Our Community</h2>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                            <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius);">
                                                <i class="fas fa-user" style="font-size: 2.5rem; color: var(--primary-light); margin-bottom: 15px;"></i>
                                                <h3 style="margin-bottom: 10px;">For Buyers</h3>
                                                <p>Get fresh, local produce delivered to your door. Support local farmers and eat healthier.</p>
                                            </div>
                                            <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius);">
                                                <i class="fas fa-tractor" style="font-size: 2.5rem; color: var(--primary-light); margin-bottom: 15px;"></i>
                                                <h3 style="margin-bottom: 10px;">For Farmers</h3>
                                                <p>Sell your products directly to customers. Reach more buyers and grow your business.</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary btn-lg" id="join-now-btn">Join Now</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                this.updateUI();
                
                // Add event listeners to product cards
                products.forEach(product => {
                    document.getElementById(`product-${product.id}`).addEventListener('click', () => {
                        this.renderProductDetails(product.id);
                    });
                    
                    if (this.app.currentUser && this.app.currentUser.type === 'buyer') {
                        document.getElementById(`add-to-cart-${product.id}`).addEventListener('click', (e) => {
                            e.stopPropagation();
                            const result = this.app.addToCart(product.id, 1);
                            if (result.success) {
                                this.app.showNotification('Added to Cart', `${product.name} has been added to your cart.`);
                            } else {
                                this.app.showNotification('Error', result.error, 'error');
                            }
                        });
                    }
                });
                
                if (document.getElementById('join-now-btn')) {
                    document.getElementById('join-now-btn').addEventListener('click', () => {
                        this.renderSignupForm();
                    });
                }
            }
            
            renderProductCard(product) {
                const canBuy = this.app.currentUser && this.app.currentUser.type === 'buyer';
                
                return `
                    <div class="product-card" id="product-${product.id}">
                        <div class="product-img-container">
                            <img src="${product.image}" alt="${product.name}" class="product-img">
                            ${product.stock < 10 ? `<div class="product-badge">Low Stock</div>` : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-header">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-price">$${product.price} ${product.unit}</div>
                            </div>
                            <div class="product-farmer">
                                <i class="fas fa-user"></i>
                                <span>${product.farmer}</span>
                            </div>
                            <p class="product-description">${product.description}</p>
                            <div class="product-meta">
                                <span><i class="fas fa-map-marker-alt"></i> ${product.location}</span>
                                <span><i class="fas fa-truck"></i> ${product.delivery ? 'Delivery' : 'Pickup'}</span>
                            </div>
                            <div class="product-meta">
                                <span><i class="fas fa-star" style="color: #FF9800;"></i> ${product.rating} (${product.reviews.length})</span>
                                <span><i class="fas fa-box"></i> ${product.stock} in stock</span>
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-outline btn-sm" style="flex: 1;">View Details</button>
                                ${canBuy ? `
                                    <button class="btn btn-primary btn-sm" id="add-to-cart-${product.id}" style="flex: 1;">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderMarketplace() {
                this.app.currentView = 'market';
                const products = this.app.db.getAllProducts();
                
                document.getElementById('content-area').innerHTML = `
                    <div class="content-wrapper">
                        <div class="sidebar">
                            <h3 class="sidebar-title">Filters</h3>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" id="category-filter">
                                    <option value="">All Categories</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="fruits">Fruits</option>
                                    <option value="dairy-eggs">Dairy & Eggs</option>
                                    <option value="meat">Meat</option>
                                    <option value="herbs">Herbs</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Price Range</label>
                                <select class="form-control" id="price-filter">
                                    <option value="">Any Price</option>
                                    <option value="0-5">Under $5</option>
                                    <option value="5-10">$5 - $10</option>
                                    <option value="10-20">$10 - $20</option>
                                    <option value="20+">Over $20</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Delivery</label>
                                <select class="form-control" id="delivery-filter">
                                    <option value="">Any</option>
                                    <option value="delivery">Delivery Available</option>
                                    <option value="pickup">Pickup Only</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sort By</label>
                                <select class="form-control" id="sort-filter">
                                    <option value="newest">Newest First</option>
                                    <option value="price-low">Price: Low to High</option>
                                    <option value="price-high">Price: High to Low</option>
                                    <option value="rating">Highest Rated</option>
                                    <option value="name">Name A-Z</option>
                                </select>
                            </div>
                            <button class="btn btn-outline btn-block" id="apply-filters">Apply Filters</button>
                            <button class="btn btn-block" id="reset-filters" style="margin-top: 10px;">Reset</button>
                        </div>
                        
                        <div class="main-content">
                            <div class="products-header">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="search-products" placeholder="Search products...">
                                </div>
                                <div>
                                    <span style="color: var(--text-light);">${products.length} products found</span>
                                </div>
                            </div>
                            
                            <div class="products-grid" id="marketplace-products">
                                ${products.map(product => this.renderProductCard(product)).join('')}
                            </div>
                            
                            ${this.app.currentUser && this.app.currentUser.type === 'farmer' ? `
                                <div style="text-align: center; margin-top: 40px;">
                                    <button class="btn btn-primary btn-lg" id="add-product-market-btn">
                                        <i class="fas fa-plus"></i> Add New Product
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                this.updateUI();
                
                // Add event listeners
                products.forEach(product => {
                    document.getElementById(`product-${product.id}`).addEventListener('click', () => {
                        this.renderProductDetails(product.id);
                    });
                    
                    if (this.app.currentUser && this.app.currentUser.type === 'buyer') {
                        document.getElementById(`add-to-cart-${product.id}`).addEventListener('click', (e) => {
                            e.stopPropagation();
                            const result = this.app.addToCart(product.id, 1);
                            if (result.success) {
                                this.app.showNotification('Added to Cart', `${product.name} has been added to your cart.`);
                            } else {
                                this.app.showNotification('Error', result.error, 'error');
                            }
                        });
                    }
                });
                
                // Filter functionality
                document.getElementById('apply-filters').addEventListener('click', () => {
                    this.applyFilters();
                });
                
                document.getElementById('reset-filters').addEventListener('click', () => {
                    document.getElementById('category-filter').value = '';
                    document.getElementById('price-filter').value = '';
                    document.getElementById('delivery-filter').value = '';
                    document.getElementById('sort-filter').value = 'newest';
                    document.getElementById('search-products').value = '';
                    this.applyFilters();
                });
                
                document.getElementById('search-products').addEventListener('input', () => {
                    this.applyFilters();
                });
                
                ['category-filter', 'price-filter', 'delivery-filter', 'sort-filter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.applyFilters();
                    });
                });
                
                if (document.getElementById('add-product-market-btn')) {
                    document.getElementById('add-product-market-btn').addEventListener('click', () => {
                        this.renderAddProductForm();
                    });
                }
            }
            
            applyFilters() {
                const searchTerm = document.getElementById('search-products').value.toLowerCase();
                const category = document.getElementById('category-filter').value;
                const priceRange = document.getElementById('price-filter').value;
                const delivery = document.getElementById('delivery-filter').value;
                const sortBy = document.getElementById('sort-filter').value;
                
                let products = this.app.db.getAllProducts();
                
                // Apply filters
                if (searchTerm) {
                    products = products.filter(p => 
                        p.name.toLowerCase().includes(searchTerm) || 
                        p.description.toLowerCase().includes(searchTerm) ||
                        p.farmer.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (category) {
                    products = products.filter(p => p.category === category);
                }
                
                if (priceRange) {
                    const [min, max] = priceRange.split('-').map(Number);
                    if (max) {
                        products = products.filter(p => p.price >= min && p.price <= max);
                    } else {
                        products = products.filter(p => p.price >= min);
                    }
                }
                
                if (delivery === 'delivery') {
                    products = products.filter(p => p.delivery);
                } else if (delivery === 'pickup') {
                    products = products.filter(p => !p.delivery);
                }
                
                // Apply sorting
                switch (sortBy) {
                    case 'price-low':
                        products.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-high':
                        products.sort((a, b) => b.price - a.price);
                        break;
                    case 'rating':
                        products.sort((a, b) => b.rating - a.rating);
                        break;
                    case 'name':
                        products.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'newest':
                    default:
                        products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        break;
                }
                
                // Update product count
                document.querySelector('.products-header span').textContent = `${products.length} products found`;
                
                // Render filtered products
                const container = document.getElementById('marketplace-products');
                container.innerHTML = products.map(product => this.renderProductCard(product)).join('');
                
                // Re-add event listeners
                products.forEach(product => {
                    document.getElementById(`product-${product.id}`).addEventListener('click', () => {
                        this.renderProductDetails(product.id);
                    });
                    
                    if (this.app.currentUser && this.app.currentUser.type === 'buyer') {
                        const btn = document.getElementById(`add-to-cart-${product.id}`);
                        if (btn) {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const result = this.app.addToCart(product.id, 1);
                                if (result.success) {
                                    this.app.showNotification('Added to Cart', `${product.name} has been added to your cart.`);
                                } else {
                                    this.app.showNotification('Error', result.error, 'error');
                                }
                            });
                        }
                    }
                });
            }
            
            renderProductDetails(productId) {
                const product = this.app.db.getProductById(productId);
                const reviews = this.app.db.getReviewsByProduct(productId);
                const canBuy = this.app.currentUser && this.app.currentUser.type === 'buyer';
                const canReview = this.app.currentUser && this.app.currentUser.type === 'buyer' && 
                    this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer')
                        .some(order => order.items.some(item => item.productId === productId) && order.status === 'delivered');
                
                document.getElementById('product-modal-title').textContent = product.name;
                document.getElementById('product-modal-body').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
                        <div>
                            <img src="${product.image}" alt="${product.name}" style="width: 100%; border-radius: var(--border-radius);">
                        </div>
                        <div>
                            <h2 style="margin-bottom: 10px;">${product.name}</h2>
                            <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-light); margin-bottom: 20px;">
                                $${product.price} ${product.unit}
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 5px; background: #FFF3E0; padding: 5px 10px; border-radius: 20px;">
                                    <i class="fas fa-star" style="color: #FF9800;"></i>
                                    <span style="font-weight: 600;">${product.rating}</span>
                                    <span style="color: var(--text-light);">(${reviews.length} reviews)</span>
                                </div>
                                <div style="background: #E8F5E9; padding: 5px 10px; border-radius: 20px;">
                                    <i class="fas fa-box"></i> ${product.stock} in stock
                                </div>
                            </div>
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin-bottom: 10px;">Sold by</h4>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 50px; height: 50px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                        ${product.farmer.charAt(0)}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${product.farmer}</div>
                                        <div style="color: var(--text-light); font-size: 0.9rem;">
                                            <i class="fas fa-map-marker-alt"></i> ${product.location}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 30px;">
                                <h4 style="margin-bottom: 10px;">Product Details</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><i class="fas fa-truck"></i> ${product.delivery ? 'Delivery Available' : 'Pickup Only'}</div>
                                    <div><i class="fas fa-credit-card"></i> ${product.paymentMethods.map(m => m.replace('_', ' ')).join(', ')}</div>
                                    <div><i class="fas fa-calendar"></i> Listed on ${new Date(product.createdAt).toLocaleDateString()}</div>
                                    <div><i class="fas fa-tag"></i> ${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</div>
                                </div>
                            </div>
                            ${canBuy ? `
                                <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                                    <div style="flex: 1;">
                                        <label class="form-label">Quantity</label>
                                        <div class="quantity-control">
                                            <button class="quantity-btn" id="decrease-qty">-</button>
                                            <span id="product-qty" style="font-weight: 600; min-width: 30px; text-align: center;">1</span>
                                            <button class="quantity-btn" id="increase-qty">+</button>
                                        </div>
                                    </div>
                                    <div style="flex: 2;">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary btn-block" id="add-to-cart-details">
                                            <i class="fas fa-cart-plus"></i> Add to Cart
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">Description</h3>
                        <p style="line-height: 1.8; color: var(--text-color);">${product.description}</p>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3>Customer Reviews</h3>
                            ${canReview ? `
                                <button class="btn btn-outline" id="add-review-btn">
                                    <i class="fas fa-plus"></i> Add Review
                                </button>
                            ` : ''}
                        </div>
                        
                        ${reviews.length > 0 ? `
                            <div id="product-reviews">
                                ${reviews.map(review => `
                                    <div class="review-card">
                                        <div class="review-header">
                                            <div>
                                                <div class="reviewer">${review.userName}</div>
                                                <div class="review-date">${new Date(review.date).toLocaleDateString()}</div>
                                            </div>
                                            <div class="review-rating">
                                                ${''.repeat(review.rating)}${''.repeat(5 - review.rating)}
                                            </div>
                                        </div>
                                        <p class="review-text">${review.comment}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: var(--border-radius);">
                                <i class="fas fa-comment" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                                <h4 style="margin-bottom: 10px;">No Reviews Yet</h4>
                                <p style="color: var(--text-light);">Be the first to review this product!</p>
                            </div>
                        `}
                    </div>
                `;
                
                document.getElementById('product-modal').style.display = 'flex';
                
                // Add event listeners
                if (canBuy) {
                    let quantity = 1;
                    
                    document.getElementById('increase-qty').addEventListener('click', () => {
                        if (quantity < product.stock) {
                            quantity++;
                            document.getElementById('product-qty').textContent = quantity;
                        }
                    });
                    
                    document.getElementById('decrease-qty').addEventListener('click', () => {
                        if (quantity > 1) {
                            quantity--;
                            document.getElementById('product-qty').textContent = quantity;
                        }
                    });
                    
                    document.getElementById('add-to-cart-details').addEventListener('click', () => {
                        const result = this.app.addToCart(product.id, quantity);
                        if (result.success) {
                            this.app.showNotification('Added to Cart', `${product.name} (${quantity}) has been added to your cart.`);
                            document.getElementById('product-modal').style.display = 'none';
                        } else {
                            this.app.showNotification('Error', result.error, 'error');
                        }
                    });
                }
                
                if (canReview) {
                    document.getElementById('add-review-btn').addEventListener('click', () => {
                        this.renderAddReviewForm(productId);
                    });
                }
            }
            
            renderAddReviewForm(productId) {
                document.getElementById('product-modal-body').innerHTML = `
                    <div style="max-width: 500px; margin: 0 auto;">
                        <h3 style="margin-bottom: 30px; text-align: center;">Add Your Review</h3>
                        <div class="form-group">
                            <label class="form-label">Rating</label>
                            <div class="rating-input">
                                <input type="radio" id="star5" name="rating" value="5">
                                <label for="star5" title="5 stars"></label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4" title="4 stars"></label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3" title="3 stars"></label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2" title="2 stars"></label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1" title="1 star"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Review</label>
                            <textarea class="form-control" id="review-comment" rows="5" placeholder="Share your experience with this product..."></textarea>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="cancel-review" style="flex: 1;">Cancel</button>
                            <button class="btn btn-primary" id="submit-review" style="flex: 1;">Submit Review</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('cancel-review').addEventListener('click', () => {
                    this.renderProductDetails(productId);
                });
                
                document.getElementById('submit-review').addEventListener('click', () => {
                    const rating = document.querySelector('input[name="rating"]:checked');
                    const comment = document.getElementById('review-comment').value;
                    
                    if (!rating) {
                        this.app.showNotification('Error', 'Please select a rating', 'error');
                        return;
                    }
                    
                    if (!comment.trim()) {
                        this.app.showNotification('Error', 'Please write a review', 'error');
                        return;
                    }
                    
                    const review = this.app.db.createReview({
                        productId,
                        userId: this.app.currentUser.id,
                        userName: this.app.currentUser.name,
                        rating: parseInt(rating.value),
                        comment
                    });
                    
                    this.app.showNotification('Review Submitted', 'Thank you for your review!');
                    this.renderProductDetails(productId);
                });
            }
            
            renderCart() {
                const cartItems = Object.values(this.app.cart);
                
                if (cartItems.length === 0) {
                    document.getElementById('cart-modal-body').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px;">Your Cart is Empty</h3>
                            <p style="color: var(--text-light); margin-bottom: 30px;">Add some fresh products from our marketplace!</p>
                            <button class="btn btn-primary" id="browse-products-cart">Browse Products</button>
                        </div>
                    `;
                    
                    document.getElementById('browse-products-cart').addEventListener('click', () => {
                        document.getElementById('cart-modal').style.display = 'none';
                        this.renderMarketplace();
                    });
                } else {
                    document.getElementById('cart-modal-body').innerHTML = `
                        <div id="cart-items">
                            ${cartItems.map(item => `
                                <div class="cart-item" id="cart-item-${item.productId}">
                                    <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                                    <div class="cart-item-info">
                                        <h4 class="cart-item-title">${item.name}</h4>
                                        <p class="cart-item-farmer">Sold by ${item.farmer}</p>
                                        <div class="cart-item-price">$${item.total.toFixed(2)}</div>
                                    </div>
                                    <div class="cart-item-actions">
                                        <div class="quantity-control">
                                            <button class="quantity-btn" data-action="decrease" data-id="${item.productId}">-</button>
                                            <span style="font-weight: 600; min-width: 30px; text-align: center;">${item.quantity}</span>
                                            <button class="quantity-btn" data-action="increase" data-id="${item.productId}">+</button>
                                        </div>
                                        <button class="btn btn-outline btn-sm" data-action="remove" data-id="${item.productId}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="cart-total">
                            <span>Total:</span>
                            <span>$${this.app.getCartTotal().toFixed(2)}</span>
                        </div>
                        <button class="btn btn-primary btn-block btn-lg" id="checkout-btn">
                            <i class="fas fa-lock"></i> Proceed to Checkout
                        </button>
                    `;
                    
                    // Add event listeners to cart buttons
                    document.querySelectorAll('[data-action="decrease"]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = parseInt(e.target.getAttribute('data-id'));
                            const item = this.app.cart[productId];
                            if (item.quantity > 1) {
                                this.app.updateCartItem(productId, item.quantity - 1);
                                this.renderCart();
                            }
                        });
                    });
                    
                    document.querySelectorAll('[data-action="increase"]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = parseInt(e.target.getAttribute('data-id'));
                            const item = this.app.cart[productId];
                            const product = this.app.db.getProductById(productId);
                            if (item.quantity < product.stock) {
                                this.app.updateCartItem(productId, item.quantity + 1);
                                this.renderCart();
                            } else {
                                this.app.showNotification('Error', `Only ${product.stock} items available in stock`, 'error');
                            }
                        });
                    });
                    
                    document.querySelectorAll('[data-action="remove"]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = parseInt(e.target.getAttribute('data-id'));
                            this.app.removeFromCart(productId);
                            this.renderCart();
                            this.app.showNotification('Item Removed', 'Item has been removed from your cart.');
                        });
                    });
                    
                    document.getElementById('checkout-btn').addEventListener('click', () => {
                        document.getElementById('cart-modal').style.display = 'none';
                        this.renderCheckout();
                    });
                }
                
                document.getElementById('cart-modal').style.display = 'flex';
            }
            
            renderCheckout() {
                const paymentMethods = this.app.paymentService.getPaymentMethods();
                const cartItems = Object.values(this.app.cart);
                
                document.getElementById('checkout-modal-body').innerHTML = `
                    <div class="checkout-steps">
                        <div class="checkout-step active" id="step-1">
                            <div class="step-number">1</div>
                            <div class="step-title">Cart</div>
                        </div>
                        <div class="checkout-step" id="step-2">
                            <div class="step-number">2</div>
                            <div class="step-title">Details</div>
                        </div>
                        <div class="checkout-step" id="step-3">
                            <div class="step-number">3</div>
                            <div class="step-title">Payment</div>
                        </div>
                        <div class="checkout-step" id="step-4">
                            <div class="step-number">4</div>
                            <div class="step-title">Confirm</div>
                        </div>
                    </div>
                    
                    <div id="checkout-step-1">
                        <h3 style="margin-bottom: 25px;">Review Your Order</h3>
                        <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px;">
                            ${cartItems.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee;">
                                    <div>
                                        <div style="font-weight: 600;">${item.name}</div>
                                        <div style="color: var(--text-light); font-size: 0.9rem;">${item.quantity} x $${item.price}</div>
                                    </div>
                                    <div style="font-weight: 600;">$${item.total.toFixed(2)}</div>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0; font-size: 1.2rem; font-weight: 600;">
                                <span>Total:</span>
                                <span>$${this.app.getCartTotal().toFixed(2)}</span>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-block" id="next-to-details">Continue to Details</button>
                    </div>
                    
                    <div id="checkout-step-2" style="display: none;">
                        <h3 style="margin-bottom: 25px;">Delivery Details</h3>
                        <div class="form-group">
                            <label class="form-label">Delivery Method</label>
                            <select class="form-control" id="delivery-method">
                                <option value="delivery">Home Delivery</option>
                                <option value="pickup">Farm Pickup</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shipping Address</label>
                            <textarea class="form-control" id="shipping-address" rows="4" placeholder="Enter your full address">${this.app.currentUser.address || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Phone</label>
                            <input type="tel" class="form-control" id="contact-phone" value="${this.app.currentUser.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delivery Instructions (Optional)</label>
                            <textarea class="form-control" id="delivery-instructions" rows="3" placeholder="Any special instructions for delivery?"></textarea>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="back-to-cart" style="flex: 1;">Back</button>
                            <button class="btn btn-primary" id="next-to-payment" style="flex: 1;">Continue to Payment</button>
                        </div>
                    </div>
                    
                    <div id="checkout-step-3" style="display: none;">
                        <h3 style="margin-bottom: 25px;">Select Payment Method</h3>
                        <div class="payment-methods">
                            ${paymentMethods.map(method => `
                                <div class="payment-method" data-method="${method.id}" id="payment-${method.id}">
                                    <i class="fab ${method.icon}"></i>
                                    <div class="payment-method-title">${method.name}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">${method.description}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div id="payment-details" style="display: none; margin-top: 30px;">
                            <div class="form-group">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="card-number" placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Expiry Date</label>
                                    <input type="text" class="form-control" id="card-expiry" placeholder="MM/YY">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="card-cvv" placeholder="123">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name on Card</label>
                                <input type="text" class="form-control" id="card-name" placeholder="John Doe">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="back-to-details" style="flex: 1;">Back</button>
                            <button class="btn btn-primary" id="next-to-confirm" style="flex: 1;">Continue to Confirm</button>
                        </div>
                    </div>
                    
                    <div id="checkout-step-4" style="display: none;">
                        <h3 style="margin-bottom: 25px;">Confirm Your Order</h3>
                        <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px;">
                            <div id="order-summary">
                                <!-- Order summary will be populated by JavaScript -->
                            </div>
                        </div>
                        <div style="background: #E8F5E9; padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-light);"></i>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Order Summary</div>
                                    <div style="color: var(--text-light);">Review your order before confirming</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-outline" id="back-to-payment" style="flex: 1;">Back</button>
                            <button class="btn btn-primary" id="confirm-order" style="flex: 1;">
                                <i class="fas fa-lock"></i> Place Order
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('checkout-modal').style.display = 'flex';
                
                // Step 1: Cart review
                document.getElementById('next-to-details').addEventListener('click', () => {
                    this.goToCheckoutStep(2);
                });
                
                // Step 2: Details
                document.getElementById('back-to-cart').addEventListener('click', () => {
                    this.goToCheckoutStep(1);
                });
                
                document.getElementById('next-to-payment').addEventListener('click', () => {
                    // Validate details
                    const address = document.getElementById('shipping-address').value.trim();
                    const phone = document.getElementById('contact-phone').value.trim();
                    
                    if (!address) {
                        this.app.showNotification('Error', 'Please enter your shipping address', 'error');
                        return;
                    }
                    
                    if (!phone) {
                        this.app.showNotification('Error', 'Please enter your contact phone', 'error');
                        return;
                    }
                    
                    this.goToCheckoutStep(3);
                });
                
                // Step 3: Payment
                document.getElementById('back-to-details').addEventListener('click', () => {
                    this.goToCheckoutStep(2);
                });
                
                // Payment method selection
                document.querySelectorAll('.payment-method').forEach(method => {
                    method.addEventListener('click', () => {
                        document.querySelectorAll('.payment-method').forEach(m => {
                            m.classList.remove('selected');
                        });
                        method.classList.add('selected');
                        
                        // Show/hide card details
                        const paymentId = method.getAttribute('data-method');
                        const paymentDetails = document.getElementById('payment-details');
                        if (paymentId === 'credit_card') {
                            paymentDetails.style.display = 'block';
                        } else {
                            paymentDetails.style.display = 'none';
                        }
                    });
                });
                
                // Select first payment method by default
                document.querySelector('.payment-method').classList.add('selected');
                
                document.getElementById('next-to-confirm').addEventListener('click', () => {
                    // Validate payment
                    const selectedMethod = document.querySelector('.payment-method.selected');
                    if (!selectedMethod) {
                        this.app.showNotification('Error', 'Please select a payment method', 'error');
                        return;
                    }
                    
                    const paymentId = selectedMethod.getAttribute('data-method');
                    
                    if (paymentId === 'credit_card') {
                        const cardNumber = document.getElementById('card-number').value.trim();
                        const cardExpiry = document.getElementById('card-expiry').value.trim();
                        const cardCVV = document.getElementById('card-cvv').value.trim();
                        const cardName = document.getElementById('card-name').value.trim();
                        
                        if (!cardNumber || !cardExpiry || !cardCVV || !cardName) {
                            this.app.showNotification('Error', 'Please fill in all card details', 'error');
                            return;
                        }
                        
                        // Simple card validation
                        if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                            this.app.showNotification('Error', 'Please enter a valid 16-digit card number', 'error');
                            return;
                        }
                        
                        if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                            this.app.showNotification('Error', 'Please enter expiry date in MM/YY format', 'error');
                            return;
                        }
                        
                        if (!/^\d{3,4}$/.test(cardCVV)) {
                            this.app.showNotification('Error', 'Please enter a valid CVV (3 or 4 digits)', 'error');
                            return;
                        }
                    }
                    
                    // Update order summary
                    const deliveryMethod = document.getElementById('delivery-method').value;
                    const address = document.getElementById('shipping-address').value;
                    const phone = document.getElementById('contact-phone').value;
                    const instructions = document.getElementById('delivery-instructions').value;
                    
                    const orderSummary = `
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">Delivery Details</div>
                            <div style="color: var(--text-light);">
                                <div>${deliveryMethod === 'delivery' ? 'Home Delivery' : 'Farm Pickup'}</div>
                                <div>${address}</div>
                                <div>${phone}</div>
                                ${instructions ? `<div>Instructions: ${instructions}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">Payment Method</div>
                            <div style="color: var(--text-light);">
                                ${paymentId === 'credit_card' ? 'Credit Card' : 
                                  paymentId === 'paypal' ? 'PayPal' :
                                  paymentId === 'apple_pay' ? 'Apple Pay' :
                                  paymentId === 'google_pay' ? 'Google Pay' :
                                  paymentId === 'venmo' ? 'Venmo' : 'Cash on Delivery'}
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 10px;">Order Items</div>
                            ${cartItems.map(item => `
                                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                                    <div>${item.name} x ${item.quantity}</div>
                                    <div>$${item.total.toFixed(2)}</div>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; padding: 15px 0; font-weight: 600; font-size: 1.1rem;">
                                <div>Total:</div>
                                <div>$${this.app.getCartTotal().toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('order-summary').innerHTML = orderSummary;
                    this.goToCheckoutStep(4);
                });
                
                // Step 4: Confirm
                document.getElementById('back-to-payment').addEventListener('click', () => {
                    this.goToCheckoutStep(3);
                });
                
                document.getElementById('confirm-order').addEventListener('click', async () => {
                    const selectedMethod = document.querySelector('.payment-method.selected');
                    const paymentId = selectedMethod.getAttribute('data-method');
                    
                    const orderData = {
                        paymentMethod: paymentId,
                        deliveryMethod: document.getElementById('delivery-method').value,
                        shippingAddress: document.getElementById('shipping-address').value,
                        buyerPhone: document.getElementById('contact-phone').value,
                        deliveryInstructions: document.getElementById('delivery-instructions').value
                    };
                    
                    // Show loading
                    document.getElementById('confirm-order').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    document.getElementById('confirm-order').disabled = true;
                    
                    try {
                        const result = await this.app.checkout(orderData);
                        
                        if (result.success) {
                            document.getElementById('checkout-step-4').innerHTML = `
                                <div style="text-align: center; padding: 40px 20px;">
                                    <i class="fas fa-check-circle" style="font-size: 5rem; color: var(--primary-light); margin-bottom: 30px;"></i>
                                    <h3 style="margin-bottom: 15px;">Order Confirmed!</h3>
                                    <p style="color: var(--text-light); margin-bottom: 10px;">Your order #${result.order.id} has been placed successfully.</p>
                                    <p style="color: var(--text-light); margin-bottom: 30px;">A confirmation email has been sent to ${this.app.currentUser.email}</p>
                                    <div style="background: #E8F5E9; padding: 20px; border-radius: var(--border-radius); margin-bottom: 30px;">
                                        <div style="font-weight: 600; margin-bottom: 10px;">Order Details</div>
                                        <div style="color: var(--text-light);">
                                            <div>Order #: ${result.order.trackingNumber}</div>
                                            <div>Total: $${result.order.total.toFixed(2)}</div>
                                            <div>Status: ${result.order.status}</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" id="view-order-details">View Order Details</button>
                                    <button class="btn btn-outline" id="continue-shopping">Continue Shopping</button>
                                </div>
                            `;
                            
                            document.getElementById('view-order-details').addEventListener('click', () => {
                                document.getElementById('checkout-modal').style.display = 'none';
                                this.renderDashboard();
                            });
                            
                            document.getElementById('continue-shopping').addEventListener('click', () => {
                                document.getElementById('checkout-modal').style.display = 'none';
                                this.renderMarketplace();
                            });
                        } else {
                            this.app.showNotification('Payment Failed', result.error, 'error');
                            document.getElementById('confirm-order').innerHTML = '<i class="fas fa-lock"></i> Place Order';
                            document.getElementById('confirm-order').disabled = false;
                        }
                    } catch (error) {
                        this.app.showNotification('Error', 'An unexpected error occurred', 'error');
                        document.getElementById('confirm-order').innerHTML = '<i class="fas fa-lock"></i> Place Order';
                        document.getElementById('confirm-order').disabled = false;
                    }
                });
            }
            
            goToCheckoutStep(step) {
                // Update step indicators
                document.querySelectorAll('.checkout-step').forEach((stepEl, index) => {
                    if (index + 1 <= step) {
                        stepEl.classList.add('active');
                    } else {
                        stepEl.classList.remove('active');
                    }
                });
                
                // Show/hide step content
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`checkout-step-${i}`).style.display = i === step ? 'block' : 'none';
                }
            }
            
            renderLoginForm() {
                this.app.currentView = 'login';
                
                document.getElementById('content-area').innerHTML = `
                    <div class="form-container">
                        <h2>Welcome Back</h2>
                        <form id="login-form">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="login-email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="login-password" required>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                <label>
                                    <input type="checkbox" id="remember-me"> Remember me
                                </label>
                                <a href="#" id="forgot-password" style="color: var(--primary-light); text-decoration: none;">Forgot password?</a>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Log In</button>
                        </form>
                        <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid #eee;">
                            <p style="color: var(--text-light); margin-bottom: 15px;">Don't have an account?</p>
                            <button class="btn btn-outline" id="switch-to-signup">Create Account</button>
                        </div>
                    </div>
                `;
                
                this.updateUI();
                
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    const result = await this.app.login(email, password);
                    
                    if (result.success) {
                        this.app.showNotification('Welcome Back', `Hello ${result.user.name}!`);
                        this.updateUI();
                        this.renderHome();
                    } else {
                        this.app.showNotification('Login Failed', result.error, 'error');
                    }
                });
                
                document.getElementById('switch-to-signup').addEventListener('click', () => {
                    this.renderSignupForm();
                });
            }
            
            renderSignupForm() {
                this.app.currentView = 'signup';
                
                document.getElementById('content-area').innerHTML = `
                    <div class="form-container">
                        <h2>Join FarmersMarket</h2>
                        <form id="signup-form">
                            <div class="form-group">
                                <label class="form-label">I am a:</label>
                                <select class="form-control" id="user-type" required>
                                    <option value="">Select account type</option>
                                    <option value="buyer">Buyer</option>
                                    <option value="farmer">Farmer/Seller</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first-name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last-name" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="signup-email" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="signup-password" required minlength="6">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirm-password" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location (City, State)</label>
                                <input type="text" class="form-control" id="location" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="terms-agreement" required>
                                    I agree to the <a href="#" style="color: var(--primary-light);">Terms of Service</a> and <a href="#" style="color: var(--primary-light);">Privacy Policy</a>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                        </form>
                        <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid #eee;">
                            <p style="color: var(--text-light); margin-bottom: 15px;">Already have an account?</p>
                            <button class="btn btn-outline" id="switch-to-login">Log In</button>
                        </div>
                    </div>
                `;
                
                this.updateUI();
                
                document.getElementById('signup-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const userType = document.getElementById('user-type').value;
                    const firstName = document.getElementById('first-name').value;
                    const lastName = document.getElementById('last-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;
                    const location = document.getElementById('location').value;
                    const phone = document.getElementById('phone').value;
                    
                    // Validation
                    if (password !== confirmPassword) {
                        this.app.showNotification('Error', 'Passwords do not match', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        this.app.showNotification('Error', 'Password must be at least 6 characters', 'error');
                        return;
                    }
                    
                    const userData = {
                        type: userType,
                        name: `${firstName} ${lastName}`,
                        email,
                        password,
                        location,
                        phone,
                        bio: userType === 'farmer' ? 'Local farmer passionate about sustainable agriculture.' : ''
                    };
                    
                    const result = await this.app.register(userData);
                    
                    if (result.success) {
                        this.app.showNotification('Account Created', `Welcome to FarmersMarket, ${result.user.name}!`);
                        this.updateUI();
                        this.renderHome();
                    } else {
                        this.app.showNotification('Registration Failed', result.error, 'error');
                    }
                });
                
                document.getElementById('switch-to-login').addEventListener('click', () => {
                    this.renderLoginForm();
                });
            }
            
            renderDashboard() {
                if (!this.app.currentUser) {
                    this.renderLoginForm();
                    return;
                }
                
                this.app.currentView = 'dashboard';
                
                if (this.app.currentUser.type === 'farmer') {
                    this.renderFarmerDashboard();
                } else {
                    this.renderBuyerDashboard();
                }
                
                this.updateUI();
            }
            
            renderFarmerDashboard() {
                const farmerProducts = this.app.db.getProductsByFarmer(this.app.currentUser.id);
                const orders = this.app.db.getOrdersByUser(this.app.currentUser.id, 'farmer');
                const recentOrders = orders.slice(0, 5);
                
                document.getElementById('content-area').innerHTML = `
                    <div class="content-wrapper">
                        <div class="sidebar">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                                <div style="width: 60px; height: 60px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 600;">
                                    ${this.app.currentUser.name.charAt(0)}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${this.app.currentUser.name}</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">Farmer Account</div>
                                </div>
                            </div>
                            <ul class="sidebar-menu">
                                <li><a href="#" class="active" data-tab="overview"><i class="fas fa-chart-line"></i> Overview</a></li>
                                <li><a href="#" data-tab="products"><i class="fas fa-apple-alt"></i> My Products</a></li>
                                <li><a href="#" data-tab="orders"><i class="fas fa-shopping-bag"></i> Orders</a></li>
                                <li><a href="#" data-tab="reviews"><i class="fas fa-star"></i> Reviews</a></li>
                                <li><a href="#" data-tab="profile"><i class="fas fa-user-cog"></i> Profile</a></li>
                                <li><a href="#" data-tab="earnings"><i class="fas fa-money-bill-wave"></i> Earnings</a></li>
                            </ul>
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                                <button class="btn btn-primary btn-block" id="add-new-product">
                                    <i class="fas fa-plus"></i> Add New Product
                                </button>
                            </div>
                        </div>
                        
                        <div class="main-content">
                            <div id="dashboard-content">
                                <!-- Dashboard content will be loaded here based on selected tab -->
                                <div class="page-header">
                                    <h1 class="page-title">Dashboard Overview</h1>
                                    <div style="color: var(--text-light);">Welcome back, ${this.app.currentUser.name}!</div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px;">
                                    <div style="background: linear-gradient(135deg, var(--primary-light), var(--dark-color)); color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${farmerProducts.length}</div>
                                        <div>Total Products</div>
                                    </div>
                                    <div style="background: #4CAF50; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${orders.length}</div>
                                        <div>Total Orders</div>
                                    </div>
                                    <div style="background: #2196F3; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">$${orders.reduce((sum, order) => {
                                            const farmerItems = order.items.filter(item => {
                                                const product = this.app.db.getProductById(item.productId);
                                                return product && product.farmerId === this.app.currentUser.id;
                                            });
                                            return sum + farmerItems.reduce((itemSum, item) => itemSum + item.total, 0);
                                        }, 0).toFixed(0)}</div>
                                        <div>Total Earnings</div>
                                    </div>
                                    <div style="background: #FF9800; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${Math.max(...farmerProducts.map(p => p.rating), 0)}</div>
                                        <div>Average Rating</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                                    <div>
                                        <h3 style="margin-bottom: 20px;">Recent Orders</h3>
                                        ${recentOrders.length > 0 ? `
                                            <div style="background: #f9f9f9; border-radius: var(--border-radius); overflow: hidden;">
                                                ${recentOrders.map(order => {
                                                    const farmerItems = order.items.filter(item => {
                                                        const product = this.app.db.getProductById(item.productId);
                                                        return product && product.farmerId === this.app.currentUser.id;
                                                    });
                                                    const farmerTotal = farmerItems.reduce((sum, item) => sum + item.total, 0);
                                                    
                                                    return `
                                                        <div style="padding: 20px; border-bottom: 1px solid #eee;">
                                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                                <div style="font-weight: 600;">Order #${order.trackingNumber}</div>
                                                                <div style="font-size: 0.9rem; background: #E8F5E9; color: var(--primary-light); padding: 4px 12px; border-radius: 20px; font-weight: 600;">
                                                                    ${order.status}
                                                                </div>
                                                            </div>
                                                            <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 10px;">
                                                                ${new Date(order.orderDate).toLocaleDateString()} | $${farmerTotal.toFixed(2)}
                                                            </div>
                                                            <div style="font-size: 0.9rem;">
                                                                ${farmerItems.map(item => `${item.name} x ${item.quantity}`).join(', ')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: var(--border-radius);">
                                                <i class="fas fa-shopping-bag" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                                                <p style="color: var(--text-light);">No orders yet</p>
                                            </div>
                                        `}
                                    </div>
                                    
                                    <div>
                                        <h3 style="margin-bottom: 20px;">Top Products</h3>
                                        ${farmerProducts.length > 0 ? `
                                            <div style="background: #f9f9f9; border-radius: var(--border-radius); overflow: hidden;">
                                                ${farmerProducts.slice(0, 3).map(product => `
                                                    <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; gap: 15px;">
                                                        <img src="${product.image}" alt="${product.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--border-radius);">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 600; margin-bottom: 5px;">${product.name}</div>
                                                            <div style="display: flex; justify-content: space-between;">
                                                                <div style="color: var(--primary-light); font-weight: 600;">$${product.price}</div>
                                                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                                                    <i class="fas fa-star" style="color: #FF9800;"></i> ${product.rating}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: var(--border-radius);">
                                                <i class="fas fa-apple-alt" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                                                <p style="color: var(--text-light);">No products yet</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="margin-bottom: 20px;">Quick Actions</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                        <button class="btn btn-outline" id="quick-add-product">
                                            <i class="fas fa-plus"></i> Add Product
                                        </button>
                                        <button class="btn btn-outline" id="quick-view-orders">
                                            <i class="fas fa-eye"></i> View Orders
                                        </button>
                                        <button class="btn btn-outline" id="quick-update-profile">
                                            <i class="fas fa-edit"></i> Update Profile
                                        </button>
                                        <button class="btn btn-outline" id="quick-view-earnings">
                                            <i class="fas fa-chart-bar"></i> View Earnings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for tabs
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Update active tab
                        document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        const tab = link.getAttribute('data-tab');
                        this.loadFarmerTab(tab);
                    });
                });
                
                // Add event listener for add new product button
                document.getElementById('add-new-product').addEventListener('click', () => {
                    this.renderAddProductForm();
                });
                
                // Quick action buttons
                document.getElementById('quick-add-product').addEventListener('click', () => {
                    this.renderAddProductForm();
                });
                
                document.getElementById('quick-view-orders').addEventListener('click', () => {
                    document.querySelector('.sidebar-menu a[data-tab="orders"]').click();
                });
                
                document.getElementById('quick-update-profile').addEventListener('click', () => {
                    document.querySelector('.sidebar-menu a[data-tab="profile"]').click();
                });
                
                document.getElementById('quick-view-earnings').addEventListener('click', () => {
                    document.querySelector('.sidebar-menu a[data-tab="earnings"]').click();
                });
            }
            
            loadFarmerTab(tab) {
                const contentDiv = document.getElementById('dashboard-content');
                
                switch(tab) {
                    case 'products':
                        this.renderFarmerProducts();
                        break;
                    case 'orders':
                        this.renderFarmerOrders();
                        break;
                    case 'overview':
                        // Already rendered by default
                        break;
                    default:
                        contentDiv.innerHTML = `<h2>${tab.charAt(0).toUpperCase() + tab.slice(1)}</h2><p>This feature is coming soon!</p>`;
                        break;
                }
            }
            
            renderFarmerProducts() {
                const products = this.app.db.getProductsByFarmer(this.app.currentUser.id);
                
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">My Products</h1>
                        <button class="btn btn-primary" id="add-product-dashboard">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>
                    
                    ${products.length > 0 ? `
                        <div class="products-grid">
                            ${products.map(product => `
                                <div class="product-card">
                                    <div class="product-img-container">
                                        <img src="${product.image}" alt="${product.name}" class="product-img">
                                        ${product.stock < 5 ? `<div class="product-badge">Low Stock</div>` : ''}
                                    </div>
                                    <div class="product-info">
                                        <div class="product-header">
                                            <h3 class="product-title">${product.name}</h3>
                                            <div class="product-price">$${product.price} ${product.unit}</div>
                                        </div>
                                        <div class="product-meta">
                                            <span><i class="fas fa-box"></i> ${product.stock} in stock</span>
                                            <span><i class="fas fa-star" style="color: #FF9800;"></i> ${product.rating}</span>
                                        </div>
                                        <p class="product-description">${product.description}</p>
                                        <div class="product-actions">
                                            <button class="btn btn-outline btn-sm" data-action="edit" data-id="${product.id}">Edit</button>
                                            <button class="btn btn-outline btn-sm" data-action="delete" data-id="${product.id}">Delete</button>
                                            <button class="btn btn-outline btn-sm" data-action="view" data-id="${product.id}">View</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-apple-alt" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px;">No Products Yet</h3>
                            <p style="color: var(--text-light); margin-bottom: 30px;">Start selling by adding your first product</p>
                            <button class="btn btn-primary" id="add-first-product">Add Your First Product</button>
                        </div>
                    `}
                `;
                
                // Add event listeners
                if (document.getElementById('add-product-dashboard')) {
                    document.getElementById('add-product-dashboard').addEventListener('click', () => {
                        this.renderAddProductForm();
                    });
                }
                
                if (document.getElementById('add-first-product')) {
                    document.getElementById('add-first-product').addEventListener('click', () => {
                        this.renderAddProductForm();
                    });
                }
                
                // Product action buttons
                document.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = parseInt(e.target.getAttribute('data-id'));
                        this.renderEditProductForm(productId);
                    });
                });
                
                document.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = parseInt(e.target.getAttribute('data-id'));
                        if (confirm('Are you sure you want to delete this product?')) {
                            this.app.db.deleteProduct(productId);
                            this.app.showNotification('Product Deleted', 'Product has been removed from your listings.');
                            this.renderFarmerProducts();
                        }
                    });
                });
                
                document.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = parseInt(e.target.getAttribute('data-id'));
                        this.renderProductDetails(productId);
                    });
                });
            }
            
            renderAddProductForm() {
                document.getElementById('content-area').innerHTML = `
                    <div class="form-container" style="max-width: 800px;">
                        <h2>Add New Product</h2>
                        <form id="add-product-form">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="product-category" required>
                                        <option value="">Select Category</option>
                                        <option value="vegetables">Vegetables</option>
                                        <option value="fruits">Fruits</option>
                                        <option value="dairy-eggs">Dairy & Eggs</option>
                                        <option value="meat">Meat</option>
                                        <option value="herbs">Herbs</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01" min="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Unit</label>
                                    <select class="form-control" id="product-unit" required>
                                        <option value="per lb">per lb</option>
                                        <option value="per kg">per kg</option>
                                        <option value="each">each</option>
                                        <option value="per dozen">per dozen</option>
                                        <option value="per bunch">per bunch</option>
                                        <option value="per bag">per bag</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" id="product-stock" min="1" value="10" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="product-description" rows="4" required></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Product Image URL</label>
                                    <input type="text" class="form-control" id="product-image" placeholder="https://example.com/image.jpg" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control" id="product-location" value="${this.app.currentUser.location}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Delivery Available?</label>
                                    <select class="form-control" id="product-delivery" required>
                                        <option value="true">Yes</option>
                                        <option value="false">No, pickup only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Delivery Fee ($)</label>
                                    <input type="number" class="form-control" id="delivery-fee" step="0.01" min="0" value="2.99" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Accepted Payment Methods</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                    <label><input type="checkbox" name="payment" value="credit_card" checked> Credit Card</label>
                                    <label><input type="checkbox" name="payment" value="paypal" checked> PayPal</label>
                                    <label><input type="checkbox" name="payment" value="cash" checked> Cash</label>
                                    <label><input type="checkbox" name="payment" value="venmo"> Venmo</label>
                                    <label><input type="checkbox" name="payment" value="apple_pay"> Apple Pay</label>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="button" class="btn btn-outline" id="cancel-add-product" style="flex: 1;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Add Product</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.getElementById('add-product-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Get payment methods
                    const paymentCheckboxes = document.querySelectorAll('input[name="payment"]:checked');
                    const paymentMethods = Array.from(paymentCheckboxes).map(cb => cb.value);
                    
                    const productData = {
                        name: document.getElementById('product-name').value,
                        category: document.getElementById('product-category').value,
                        price: parseFloat(document.getElementById('product-price').value),
                        unit: document.getElementById('product-unit').value,
                        stock: parseInt(document.getElementById('product-stock').value),
                        description: document.getElementById('product-description').value,
                        image: document.getElementById('product-image').value || 'https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80',
                        location: document.getElementById('product-location').value,
                        delivery: document.getElementById('product-delivery').value === 'true',
                        deliveryFee: parseFloat(document.getElementById('delivery-fee').value),
                        paymentMethods,
                        farmerId: this.app.currentUser.id,
                        farmer: this.app.currentUser.name
                    };
                    
                    const result = await this.app.addProduct(productData);
                    
                    if (result.success) {
                        this.app.showNotification('Product Added', `${result.product.name} has been listed successfully!`);
                        this.renderDashboard();
                    } else {
                        this.app.showNotification('Error', result.error, 'error');
                    }
                });
                
                document.getElementById('cancel-add-product').addEventListener('click', () => {
                    this.renderDashboard();
                });
            }
            
            renderEditProductForm(productId) {
                const product = this.app.db.getProductById(productId);
                
                if (!product || product.farmerId !== this.app.currentUser.id) {
                    this.app.showNotification('Error', 'You cannot edit this product', 'error');
                    this.renderDashboard();
                    return;
                }
                
                document.getElementById('content-area').innerHTML = `
                    <div class="form-container" style="max-width: 800px;">
                        <h2>Edit Product</h2>
                        <form id="edit-product-form">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="edit-product-name" value="${product.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="edit-product-category" required>
                                        <option value="vegetables" ${product.category === 'vegetables' ? 'selected' : ''}>Vegetables</option>
                                        <option value="fruits" ${product.category === 'fruits' ? 'selected' : ''}>Fruits</option>
                                        <option value="dairy-eggs" ${product.category === 'dairy-eggs' ? 'selected' : ''}>Dairy & Eggs</option>
                                        <option value="meat" ${product.category === 'meat' ? 'selected' : ''}>Meat</option>
                                        <option value="herbs" ${product.category === 'herbs' ? 'selected' : ''}>Herbs</option>
                                        <option value="other" ${product.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-control" id="edit-product-price" value="${product.price}" step="0.01" min="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Unit</label>
                                    <select class="form-control" id="edit-product-unit" required>
                                        <option value="per lb" ${product.unit === 'per lb' ? 'selected' : ''}>per lb</option>
                                        <option value="per kg" ${product.unit === 'per kg' ? 'selected' : ''}>per kg</option>
                                        <option value="each" ${product.unit === 'each' ? 'selected' : ''}>each</option>
                                        <option value="per dozen" ${product.unit === 'per dozen' ? 'selected' : ''}>per dozen</option>
                                        <option value="per bunch" ${product.unit === 'per bunch' ? 'selected' : ''}>per bunch</option>
                                        <option value="per bag" ${product.unit === 'per bag' ? 'selected' : ''}>per bag</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" id="edit-product-stock" value="${product.stock}" min="1" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="edit-product-description" rows="4" required>${product.description}</textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Product Image URL</label>
                                    <input type="text" class="form-control" id="edit-product-image" value="${product.image}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control" id="edit-product-location" value="${product.location}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Delivery Available?</label>
                                    <select class="form-control" id="edit-product-delivery" required>
                                        <option value="true" ${product.delivery ? 'selected' : ''}>Yes</option>
                                        <option value="false" ${!product.delivery ? 'selected' : ''}>No, pickup only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Delivery Fee ($)</label>
                                    <input type="number" class="form-control" id="edit-delivery-fee" value="${product.deliveryFee}" step="0.01" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Accepted Payment Methods</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                    <label><input type="checkbox" name="edit-payment" value="credit_card" ${product.paymentMethods.includes('credit_card') ? 'checked' : ''}> Credit Card</label>
                                    <label><input type="checkbox" name="edit-payment" value="paypal" ${product.paymentMethods.includes('paypal') ? 'checked' : ''}> PayPal</label>
                                    <label><input type="checkbox" name="edit-payment" value="cash" ${product.paymentMethods.includes('cash') ? 'checked' : ''}> Cash</label>
                                    <label><input type="checkbox" name="edit-payment" value="venmo" ${product.paymentMethods.includes('venmo') ? 'checked' : ''}> Venmo</label>
                                    <label><input type="checkbox" name="edit-payment" value="apple_pay" ${product.paymentMethods.includes('apple_pay') ? 'checked' : ''}> Apple Pay</label>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="button" class="btn btn-outline" id="cancel-edit-product" style="flex: 1;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Update Product</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.getElementById('edit-product-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    // Get payment methods
                    const paymentCheckboxes = document.querySelectorAll('input[name="edit-payment"]:checked');
                    const paymentMethods = Array.from(paymentCheckboxes).map(cb => cb.value);
                    
                    const updates = {
                        name: document.getElementById('edit-product-name').value,
                        category: document.getElementById('edit-product-category').value,
                        price: parseFloat(document.getElementById('edit-product-price').value),
                        unit: document.getElementById('edit-product-unit').value,
                        stock: parseInt(document.getElementById('edit-product-stock').value),
                        description: document.getElementById('edit-product-description').value,
                        image: document.getElementById('edit-product-image').value,
                        location: document.getElementById('edit-product-location').value,
                        delivery: document.getElementById('edit-product-delivery').value === 'true',
                        deliveryFee: parseFloat(document.getElementById('edit-delivery-fee').value),
                        paymentMethods
                    };
                    
                    const result = this.app.db.updateProduct(productId, updates);
                    
                    if (result) {
                        this.app.showNotification('Product Updated', `${result.name} has been updated successfully!`);
                        this.renderDashboard();
                    } else {
                        this.app.showNotification('Error', 'Failed to update product', 'error');
                    }
                });
                
                document.getElementById('cancel-edit-product').addEventListener('click', () => {
                    this.renderDashboard();
                });
            }
            
            renderFarmerOrders() {
                const orders = this.app.db.getOrdersByUser(this.app.currentUser.id, 'farmer');
                
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">My Orders</h1>
                        <div>
                            <select class="filter-select" id="order-status-filter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    ${orders.length > 0 ? `
                        <div style="background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr; padding: 20px; background: #f9f9f9; font-weight: 600; border-bottom: 1px solid #eee;">
                                <div>Order #</div>
                                <div>Customer</div>
                                <div>Date</div>
                                <div>Total</div>
                                <div>Status</div>
                            </div>
                            ${orders.map(order => {
                                const farmerItems = order.items.filter(item => {
                                    const product = this.app.db.getProductById(item.productId);
                                    return product && product.farmerId === this.app.currentUser.id;
                                });
                                const farmerTotal = farmerItems.reduce((sum, item) => sum + item.total, 0);
                                const buyer = this.app.db.getUserById(order.buyerId);
                                
                                return `
                                    <div class="order-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr; padding: 20px; border-bottom: 1px solid #eee; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600;">${order.trackingNumber}</div>
                                            <div style="font-size: 0.9rem; color: var(--text-light);">#${order.id}</div>
                                        </div>
                                        <div>
                                            <div>${buyer ? buyer.name : 'Unknown'}</div>
                                            <div style="font-size: 0.9rem; color: var(--text-light);">${order.buyerEmail}</div>
                                        </div>
                                        <div>${new Date(order.orderDate).toLocaleDateString()}</div>
                                        <div style="font-weight: 600; color: var(--primary-light);">$${farmerTotal.toFixed(2)}</div>
                                        <div>
                                            <select class="filter-select order-status" data-order-id="${order.id}" style="width: 100%;">
                                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="margin-top: 30px; padding: 25px; background: #f9f9f9; border-radius: var(--border-radius);">
                            <h3 style="margin-bottom: 20px;">Order Statistics</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-light);">
                                        ${orders.filter(o => o.status === 'pending').length}
                                    </div>
                                    <div style="color: var(--text-light);">Pending</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #2196F3;">
                                        ${orders.filter(o => o.status === 'processing').length}
                                    </div>
                                    <div style="color: var(--text-light);">Processing</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #FF9800;">
                                        ${orders.filter(o => o.status === 'shipped').length}
                                    </div>
                                    <div style="color: var(--text-light);">Shipped</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #4CAF50;">
                                        ${orders.filter(o => o.status === 'delivered').length}
                                    </div>
                                    <div style="color: var(--text-light);">Delivered</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #f44336;">
                                        ${orders.filter(o => o.status === 'cancelled').length}
                                    </div>
                                    <div style="color: var(--text-light);">Cancelled</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-shopping-bag" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px;">No Orders Yet</h3>
                            <p style="color: var(--text-light);">You haven't received any orders yet</p>
                        </div>
                    `}
                `;
                
                // Add event listener for status updates
                document.querySelectorAll('.order-status').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const orderId = parseInt(e.target.getAttribute('data-order-id'));
                        const newStatus = e.target.value;
                        
                        const updatedOrder = this.app.db.updateOrderStatus(orderId, newStatus);
                        if (updatedOrder) {
                            this.app.showNotification('Order Updated', `Order #${updatedOrder.trackingNumber} status updated to ${newStatus}`);
                        }
                    });
                });
                
                // Filter orders by status
                document.getElementById('order-status-filter').addEventListener('change', (e) => {
                    const statusFilter = e.target.value;
                    const orderRows = document.querySelectorAll('.order-row');
                    
                    orderRows.forEach(row => {
                        const statusSelect = row.querySelector('.order-status');
                        const orderStatus = statusSelect.value;
                        
                        if (!statusFilter || orderStatus === statusFilter) {
                            row.style.display = 'grid';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
            
            renderBuyerDashboard() {
                const orders = this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer');
                const recentOrders = orders.slice(0, 3);
                
                document.getElementById('content-area').innerHTML = `
                    <div class="content-wrapper">
                        <div class="sidebar">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                                <div style="width: 60px; height: 60px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 600;">
                                    ${this.app.currentUser.name.charAt(0)}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${this.app.currentUser.name}</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">Buyer Account</div>
                                </div>
                            </div>
                            <ul class="sidebar-menu">
                                <li><a href="#" class="active" data-tab="overview"><i class="fas fa-home"></i> Overview</a></li>
                                <li><a href="#" data-tab="orders"><i class="fas fa-shopping-bag"></i> My Orders</a></li>
                                <li><a href="#" data-tab="reviews"><i class="fas fa-star"></i> My Reviews</a></li>
                                <li><a href="#" data-tab="favorites"><i class="fas fa-heart"></i> Favorites</a></li>
                                <li><a href="#" data-tab="profile"><i class="fas fa-user-cog"></i> Profile</a></li>
                                <li><a href="#" data-tab="addresses"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                            </ul>
                        </div>
                        
                        <div class="main-content">
                            <div id="dashboard-content">
                                <div class="page-header">
                                    <h1 class="page-title">Dashboard Overview</h1>
                                    <div style="color: var(--text-light);">Welcome back, ${this.app.currentUser.name}!</div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px;">
                                    <div style="background: linear-gradient(135deg, var(--primary-light), var(--dark-color)); color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${orders.length}</div>
                                        <div>Total Orders</div>
                                    </div>
                                    <div style="background: #4CAF50; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">$${orders.reduce((sum, order) => sum + order.total, 0).toFixed(0)}</div>
                                        <div>Total Spent</div>
                                    </div>
                                    <div style="background: #2196F3; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${Object.keys(this.app.cart).length}</div>
                                        <div>Items in Cart</div>
                                    </div>
                                    <div style="background: #FF9800; color: white; padding: 25px; border-radius: var(--border-radius);">
                                        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;">${this.app.notifications.length}</div>
                                        <div>Notifications</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 40px;">
                                    <div>
                                        <h3 style="margin-bottom: 20px;">Recent Orders</h3>
                                        ${recentOrders.length > 0 ? `
                                            <div style="background: #f9f9f9; border-radius: var(--border-radius); overflow: hidden;">
                                                ${recentOrders.map(order => `
                                                    <div style="padding: 20px; border-bottom: 1px solid #eee;">
                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                            <div style="font-weight: 600;">Order #${order.trackingNumber}</div>
                                                            <div style="font-size: 0.9rem; background: #E8F5E9; color: var(--primary-light); padding: 4px 12px; border-radius: 20px; font-weight: 600;">
                                                                ${order.status}
                                                            </div>
                                                        </div>
                                                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 10px;">
                                                            ${new Date(order.orderDate).toLocaleDateString()} | $${order.total.toFixed(2)}
                                                        </div>
                                                        <div style="font-size: 0.9rem;">
                                                            ${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: var(--border-radius);">
                                                <i class="fas fa-shopping-bag" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                                                <p style="color: var(--text-light);">No orders yet</p>
                                                <button class="btn btn-primary" id="start-shopping" style="margin-top: 15px;">Start Shopping</button>
                                            </div>
                                        `}
                                    </div>
                                    
                                    <div>
                                        <h3 style="margin-bottom: 20px;">Quick Actions</h3>
                                        <div style="display: flex; flex-direction: column; gap: 15px;">
                                            <button class="btn btn-outline" id="quick-view-cart">
                                                <i class="fas fa-shopping-cart"></i> View Cart
                                            </button>
                                            <button class="btn btn-outline" id="quick-browse-products">
                                                <i class="fas fa-store"></i> Browse Products
                                            </button>
                                            <button class="btn btn-outline" id="quick-track-order">
                                                <i class="fas fa-truck"></i> Track Order
                                            </button>
                                            <button class="btn btn-outline" id="quick-view-notifications">
                                                <i class="fas fa-bell"></i> Notifications
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="margin-bottom: 20px;">Recommended For You</h3>
                                    <div class="products-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                                        ${this.app.db.getAllProducts().slice(0, 3).map(product => `
                                            <div class="product-card" style="transform: none;" id="recommended-${product.id}">
                                                <div class="product-img-container">
                                                    <img src="${product.image}" alt="${product.name}" class="product-img">
                                                </div>
                                                <div class="product-info">
                                                    <h3 class="product-title" style="font-size: 1.1rem;">${product.name}</h3>
                                                    <div class="product-price">$${product.price} ${product.unit}</div>
                                                    <button class="btn btn-outline btn-sm btn-block" style="margin-top: 10px;">View Details</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for tabs
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Update active tab
                        document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        const tab = link.getAttribute('data-tab');
                        this.loadBuyerTab(tab);
                    });
                });
                
                // Quick action buttons
                if (document.getElementById('start-shopping')) {
                    document.getElementById('start-shopping').addEventListener('click', () => {
                        this.renderMarketplace();
                    });
                }
                
                document.getElementById('quick-view-cart').addEventListener('click', () => {
                    this.renderCart();
                });
                
                document.getElementById('quick-browse-products').addEventListener('click', () => {
                    this.renderMarketplace();
                });
                
                document.getElementById('quick-track-order').addEventListener('click', () => {
                    document.querySelector('.sidebar-menu a[data-tab="orders"]').click();
                });
                
                document.getElementById('quick-view-notifications').addEventListener('click', () => {
                    this.showNotifications();
                });
                
                // Recommended products
                this.app.db.getAllProducts().slice(0, 3).forEach(product => {
                    document.getElementById(`recommended-${product.id}`).addEventListener('click', () => {
                        this.renderProductDetails(product.id);
                    });
                });
            }
            
            loadBuyerTab(tab) {
                switch(tab) {
                    case 'orders':
                        this.renderBuyerOrders();
                        break;
                    case 'overview':
                        // Already rendered by default
                        break;
                    default:
                        document.getElementById('dashboard-content').innerHTML = `<h2>${tab.charAt(0).toUpperCase() + tab.slice(1)}</h2><p>This feature is coming soon!</p>`;
                        break;
                }
            }
            
            renderBuyerOrders() {
                const orders = this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer');
                
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">My Orders</h1>
                        <div>
                            <select class="filter-select" id="buyer-order-filter">
                                <option value="">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    ${orders.length > 0 ? `
                        <div>
                            ${orders.map(order => `
                                <div class="order-card" style="background: white; border-radius: var(--border-radius); padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 5px;">Order #${order.trackingNumber}</div>
                                            <div style="color: var(--text-light); font-size: 0.9rem;">Placed on ${new Date(order.orderDate).toLocaleDateString()}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-light); margin-bottom: 5px;">$${order.total.toFixed(2)}</div>
                                            <div style="font-size: 0.9rem; background: #E8F5E9; color: var(--primary-light); padding: 4px 12px; border-radius: 20px; font-weight: 600; display: inline-block;">
                                                ${order.status}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: 600; margin-bottom: 10px;">Items:</div>
                                        ${order.items.map(item => `
                                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                                                <div>${item.name} x ${item.quantity}</div>
                                                <div>$${item.total.toFixed(2)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px;">
                                        <button class="btn btn-outline btn-sm" data-action="track" data-order-id="${order.id}">
                                            <i class="fas fa-truck"></i> Track Order
                                        </button>
                                        <button class="btn btn-outline btn-sm" data-action="details" data-order-id="${order.id}">
                                            <i class="fas fa-info-circle"></i> View Details
                                        </button>
                                        ${order.status === 'delivered' ? `
                                            <button class="btn btn-outline btn-sm" data-action="review" data-order-id="${order.id}">
                                                <i class="fas fa-star"></i> Write Review
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-shopping-bag" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px;">No Orders Yet</h3>
                            <p style="color: var(--text-light); margin-bottom: 30px;">Start shopping to see your orders here</p>
                            <button class="btn btn-primary" id="browse-marketplace">Browse Marketplace</button>
                        </div>
                    `}
                `;
                
                if (document.getElementById('browse-marketplace')) {
                    document.getElementById('browse-marketplace').addEventListener('click', () => {
                        this.renderMarketplace();
                    });
                }
                
                // Order action buttons
                document.querySelectorAll('[data-action="track"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = parseInt(e.target.getAttribute('data-order-id'));
                        this.showOrderTracking(orderId);
                    });
                });
                
                document.querySelectorAll('[data-action="details"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = parseInt(e.target.getAttribute('data-order-id'));
                        this.showOrderDetails(orderId);
                    });
                });
                
                document.querySelectorAll('[data-action="review"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = parseInt(e.target.getAttribute('data-order-id'));
                        const order = this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer').find(o => o.id === orderId);
                        if (order) {
                            // For simplicity, let the user review the first product in the order
                            const firstProductId = order.items[0].productId;
                            this.renderProductDetails(firstProductId);
                        }
                    });
                });
                
                // Filter orders
                document.getElementById('buyer-order-filter').addEventListener('change', (e) => {
                    const filter = e.target.value;
                    const orderCards = document.querySelectorAll('.order-card');
                    
                    orderCards.forEach(card => {
                        const status = card.querySelector('div[style*="background: #E8F5E9"]').textContent.trim().toLowerCase();
                        
                        if (!filter || status === filter) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
            
            showOrderTracking(orderId) {
                const order = this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer').find(o => o.id === orderId);
                
                if (!order) return;
                
                const trackingSteps = [
                    { status: 'ordered', label: 'Order Placed', date: order.orderDate, completed: true },
                    { status: 'processing', label: 'Processing', date: this.addDays(order.orderDate, 1), completed: order.status !== 'pending' },
                    { status: 'shipped', label: 'Shipped', date: this.addDays(order.orderDate, 2), completed: ['shipped', 'delivered'].includes(order.status) },
                    { status: 'delivered', label: 'Delivered', date: this.addDays(order.orderDate, 3), completed: order.status === 'delivered' }
                ];
                
                const currentStepIndex = trackingSteps.findIndex(step => step.status === order.status) + 1;
                
                document.getElementById('product-modal-title').textContent = `Order Tracking #${order.trackingNumber}`;
                document.getElementById('product-modal-body').innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="margin-bottom: 30px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">Order Status: <span style="color: var(--primary-light);">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></div>
                            <div style="color: var(--text-light);">Estimated delivery: ${this.addDays(order.orderDate, 3)}</div>
                        </div>
                        
                        <div style="position: relative; margin-bottom: 40px;">
                            <div style="position: absolute; top: 20px; left: 30px; right: 30px; height: 3px; background-color: #eee; z-index: 1;"></div>
                            <div style="position: absolute; top: 20px; left: 30px; width: ${(currentStepIndex - 1) * 33.33}%; height: 3px; background-color: var(--primary-light); z-index: 2;"></div>
                            
                            ${trackingSteps.map((step, index) => `
                                <div style="position: relative; z-index: 3; display: inline-block; width: 25%; text-align: center;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${step.completed ? 'var(--primary-light)' : '#eee'}; color: ${step.completed ? 'white' : 'var(--text-light)'}; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 auto 10px;">
                                        ${index + 1}
                                    </div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">${step.label}</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">${step.date}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius);">
                            <h3 style="margin-bottom: 15px;">Order Details</h3>
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 600;">Delivery Address</div>
                                <div style="color: var(--text-light);">${order.shippingAddress}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600;">Items</div>
                                ${order.items.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                                        <div>${item.name} x ${item.quantity}</div>
                                        <div>$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                                <div style="display: flex; justify-content: space-between; padding: 15px 0; font-weight: 600;">
                                    <div>Total</div>
                                    <div>$${order.total.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="close-tracking" style="flex: 1;">Close</button>
                            <button class="btn btn-primary" id="contact-farmer" style="flex: 1;">
                                <i class="fas fa-envelope"></i> Contact Farmer
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('product-modal').style.display = 'flex';
                
                document.getElementById('close-tracking').addEventListener('click', () => {
                    document.getElementById('product-modal').style.display = 'none';
                });
                
                document.getElementById('contact-farmer').addEventListener('click', () => {
                    // In a real app, this would open a contact form or chat
                    alert('Contact feature would open here. Farmer email: farmer@example.com');
                });
            }
            
            showOrderDetails(orderId) {
                const order = this.app.db.getOrdersByUser(this.app.currentUser.id, 'buyer').find(o => o.id === orderId);
                
                if (!order) return;
                
                document.getElementById('product-modal-title').textContent = `Order Details #${order.trackingNumber}`;
                document.getElementById('product-modal-body').innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Order Date</div>
                                <div style="color: var(--text-light);">${new Date(order.orderDate).toLocaleDateString()}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Status</div>
                                <div style="color: var(--primary-light); font-weight: 600;">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Payment Method</div>
                                <div style="color: var(--text-light);">${order.paymentMethod.replace('_', ' ').toUpperCase()}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Payment Status</div>
                                <div style="color: var(--primary-light); font-weight: 600;">${order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1)}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px;">
                            <h3 style="margin-bottom: 15px;">Delivery Information</h3>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Address</div>
                                <div style="color: var(--text-light); margin-bottom: 15px;">${order.shippingAddress}</div>
                                
                                <div style="font-weight: 600; margin-bottom: 5px;">Method</div>
                                <div style="color: var(--text-light); margin-bottom: 15px;">${order.deliveryMethod === 'delivery' ? 'Home Delivery' : 'Farm Pickup'}</div>
                                
                                ${order.deliveryInstructions ? `
                                    <div style="font-weight: 600; margin-bottom: 5px;">Instructions</div>
                                    <div style="color: var(--text-light);">${order.deliveryInstructions}</div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: #f9f9f9; padding: 25px; border-radius: var(--border-radius);">
                            <h3 style="margin-bottom: 15px;">Order Items</h3>
                            ${order.items.map(item => {
                                const product = this.app.db.getProductById(item.productId);
                                return `
                                    <div style="display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee;">
                                        <img src="${product ? product.image : ''}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--border-radius);">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                                            <div style="color: var(--text-light); font-size: 0.9rem;">Quantity: ${item.quantity} | Price: $${item.price}</div>
                                        </div>
                                        <div style="font-weight: 600;">$${item.total.toFixed(2)}</div>
                                    </div>
                                `;
                            }).join('')}
                            
                            <div style="padding-top: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div>Subtotal</div>
                                    <div>$${order.total.toFixed(2)}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div>Delivery Fee</div>
                                    <div>$0.00</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem; border-top: 1px solid #eee; padding-top: 15px;">
                                    <div>Total</div>
                                    <div>$${order.total.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="close-details" style="flex: 1;">Close</button>
                            <button class="btn btn-primary" id="print-invoice" style="flex: 1;">
                                <i class="fas fa-print"></i> Print Invoice
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('product-modal').style.display = 'flex';
                
                document.getElementById('close-details').addEventListener('click', () => {
                    document.getElementById('product-modal').style.display = 'none';
                });
                
                document.getElementById('print-invoice').addEventListener('click', () => {
                    window.print();
                });
            }
            
            showNotifications() {
                const notifications = this.app.notifications;
                
                document.getElementById('product-modal-title').textContent = 'Notifications';
                document.getElementById('product-modal-body').innerHTML = `
                    <div style="max-width: 500px; margin: 0 auto;">
                        ${notifications.length > 0 ? `
                            <div>
                                ${notifications.map(notification => `
                                    <div style="padding: 20px; border-bottom: 1px solid #eee;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                            <div style="font-weight: 600;">${notification.title}</div>
                                            <div style="color: var(--text-light); font-size: 0.9rem;">${new Date(notification.createdAt).toLocaleDateString()}</div>
                                        </div>
                                        <div style="color: var(--text-light); margin-bottom: 10px;">${notification.message}</div>
                                        ${notification.link ? `
                                            <a href="#" class="btn btn-outline btn-sm" data-notification-id="${notification.id}">View</a>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px 20px;">
                                <i class="fas fa-bell" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                                <h3 style="margin-bottom: 15px;">No Notifications</h3>
                                <p style="color: var(--text-light);">You're all caught up!</p>
                            </div>
                        `}
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-outline" id="close-notifications" style="flex: 1;">Close</button>
                            ${notifications.length > 0 ? `
                                <button class="btn btn-primary" id="mark-all-read" style="flex: 1;">
                                    Mark All as Read
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('product-modal').style.display = 'flex';
                
                document.getElementById('close-notifications').addEventListener('click', () => {
                    document.getElementById('product-modal').style.display = 'none';
                });
                
                if (document.getElementById('mark-all-read')) {
                    document.getElementById('mark-all-read').addEventListener('click', () => {
                        notifications.forEach(notification => {
                            this.app.db.markNotificationAsRead(notification.id);
                        });
                        this.app.notifications = [];
                        this.app.showNotification('Notifications Cleared', 'All notifications marked as read.');
                        document.getElementById('product-modal').style.display = 'none';
                    });
                }
                
                // Notification links
                document.querySelectorAll('[data-notification-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const notificationId = parseInt(e.target.getAttribute('data-notification-id'));
                        this.app.db.markNotificationAsRead(notificationId);
                        this.app.notifications = this.app.notifications.filter(n => n.id !== notificationId);
                        document.getElementById('product-modal').style.display = 'none';
                        
                        // Navigate based on notification type
                        // This is simplified - in a real app, you would have proper routing
                        this.renderDashboard();
                    });
                });
            }
            
            addDays(dateString, days) {
                const date = new Date(dateString);
                date.setDate(date.getDate() + days);
                return date.toLocaleDateString();
            }
        }

        // =============== INITIALIZE APPLICATION ===============
        document.addEventListener('DOMContentLoaded', () => {
            const appState = new AppState();
            const uiManager = new UIManager(appState);
            
            // Make appState and uiManager available globally for debugging
            window.appState = appState;
            window.uiManager = uiManager;
            
            console.log('Farmers Market System initialized successfully!');
            console.log('Sample login credentials:');
            console.log('Farmer: farmer@example.com / password123');
            console.log('Buyer: buyer@example.com / password123');
        });
    </script>
</body>
</html>
